<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Woostaa</title>
    <link rel="icon" type="image/x-icon" href="img/Blue.svg">
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            background: var(--bg-light);
            margin: 0;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--primary-blue);
            color: white;
            padding: 2rem 1rem;
            box-shadow: var(--shadow-lg);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        /* Mobile menu toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: var(--shadow-md);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-header img {
            width: 40px;
            height: 40px;
            filter: brightness(0) invert(1);
        }

        .sidebar-title {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(5px);
        }

        .nav-icon {
            font-size: 1.2rem;
            width: 20px;
        }

        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 2rem;
        }

        .header {
            background: white;
            padding: 1rem 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--text-primary);
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: var(--accent-red-bg);
            color: var(--accent-red-text);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: var(--accent-red-text);
            color: white;
        }

        .content-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--border-light);
            color: var(--text-secondary);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 0.5rem;
        }

        .btn-danger {
            background: var(--accent-red-bg);
            color: var(--accent-red-text);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-danger:hover {
            background: var(--accent-red-text);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            margin-top: 1rem;
            /* Ensure clearance from header */
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-hover));
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .data-table th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--text-primary);
        }

        .data-table tr:hover {
            background: var(--bg-light);
        }

        .search-bar {
            width: 100%;
            max-width: 400px;
            padding: 0.8rem;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-light);
            background: white;
            cursor: pointer;
            border-radius: 6px;
        }

        .pagination button.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background: var(--accent-green-bg);
            color: var(--accent-green-text);
        }

        .status-inactive {
            background: var(--accent-red-bg);
            color: var(--accent-red-text);
        }

        .status-verified {
            background: var(--accent-green-bg);
            color: var(--accent-green-text);
        }

        .status-unverified {
            background: var(--accent-yellow-bg);
            color: var(--accent-yellow-text);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }

            .main-content {
                margin-left: 240px;
                padding: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 1002;
                background: var(--primary-blue);
                color: white;
                border: none;
                padding: 0.8rem;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            }

            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                position: fixed;
                height: 100vh;
                z-index: 1001;
                box-shadow: 2px 0 20px rgba(0, 0, 0, 0.2);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
                backdrop-filter: blur(2px);
            }

            .sidebar-overlay.active {
                opacity: 1;
                visibility: visible;
            }

            .main-content {
                margin-left: 0;
                padding: 5rem 1rem 2rem 1rem;
                width: 100%;
                box-sizing: border-box;
            }

            .header {
                padding: 1.2rem;
                margin-bottom: 1.5rem;
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .admin-info {
                width: 100%;
                justify-content: center;
            }

            .header h1 {
                font-size: 1.5rem;
                order: -1;
            }

            .admin-container {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr !important;
                /* Force stack */
                gap: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                /* Stack stats */
                gap: 1rem;
            }

            /* Improve scrolling tables */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -1rem;
                /* Negative margin to pull to edges */
                padding: 0 1rem;
                width: calc(100% + 2rem);
            }

            .data-table {
                min-width: 600px;
                font-size: 0.9rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.8rem;
            }

            /* Better Modals */
            .modal-content {
                width: 95%;
                margin: 1rem;
                padding: 1.2rem;
                max-height: 85vh;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 0.8rem;
                /* Larger touch targets */
                font-size: 16px;
                /* Prevent zoom on iOS */
            }

            /* Scrollable Tabs */
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
                margin-right: -1rem;
                /* Allow scroll to edge */
                padding-right: 1rem;
            }

            .tab-btn {
                flex-shrink: 0;
                padding: 0.6rem 1rem !important;
                background: #f8f9fa !important;
                border: 1px solid #eee !important;
                border-radius: 20px;
                margin-right: 0.5rem;
            }

            .tab-btn.active {
                background: var(--primary-blue) !important;
                color: white !important;
                border-color: var(--primary-blue) !important;
            }

            .section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .section-header button {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>

    <div class="admin-container">
        <aside class="sidebar" id="adminSidebar">
            <div class="sidebar-header">
                <img src="img/PrimaryBlueshape.svg" alt="Woostaa">
                <span class="sidebar-title">Admin Panel</span>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link active" data-section="dashboard">
                            <i class="nav-icon bi bi-speedometer2"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="users">
                            <i class="nav-icon bi bi-people-fill"></i>
                            Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="workers">
                            <i class="nav-icon bi bi-person-badge-fill"></i>
                            Workers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="apartments">
                            <i class="nav-icon bi bi-building-fill"></i>
                            Apartments
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="services">
                            <i class="nav-icon bi bi-gear-fill"></i>
                            Services & Pricing
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="orders">
                            <i class="nav-icon bi bi-clipboard-check-fill"></i>
                            Orders
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1 id="pageTitle">Dashboard</h1>
                <div class="admin-info">
                    <span id="adminName">Admin</span>
                    <button class="logout-btn" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </header>

            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section active">
                <div class="stats-grid" id="statsGrid">
                    <div class="loading">Loading statistics...</div>
                </div>
                <div class="content-section">
                    <h2 class="section-title">Recent Orders</h2>
                    <div id="recentOrders" class="loading">Loading orders...</div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users-section" class="section">
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">User Management</h2>
                    </div>
                    <input type="text" class="search-bar" id="userSearch" placeholder="Search users...">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Registered</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="6" class="loading">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="usersPagination"></div>
                </div>
            </div>

            <!-- Workers Section -->
            <div id="workers-section" class="section">
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">Worker Management</h2>
                        <button class="btn-primary" onclick="openWorkerModal()">Add Worker</button>
                    </div>
                    <input type="text" class="search-bar" id="workerSearch" placeholder="Search workers...">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Services</th>
                                    <th>Areas</th>
                                    <th>Rating</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="workersTableBody">
                                <tr>
                                    <td colspan="7" class="loading">Loading workers...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="workersPagination"></div>
                </div>
            </div>

            <!-- Apartments Section -->
            <div id="apartments-section" class="section">
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">Apartment Management</h2>
                        <button class="btn-primary" onclick="openApartmentModal()">Add Apartment</button>
                    </div>
                    <input type="text" class="search-bar" id="apartmentSearch" placeholder="Search apartments...">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Area</th>
                                    <th>Pincode</th>
                                    <th>Total Units</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="apartmentsTableBody">
                                <tr>
                                    <td colspan="6" class="loading">Loading apartments...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="apartmentsPagination"></div>
                </div>
            </div>

            <!-- Services Section (Specific Service Management) -->
            <div id="services-section" class="section">
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">Service Pricing & Management</h2>
                    </div>

                    <!-- Service Type Tabs -->
                    <div class="tabs"
                        style="margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); display: flex; gap: 1rem;">
                        <button class="tab-btn active" onclick="switchServiceTab('car-wash')" id="tab-car-wash"
                            style="padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid var(--primary-color); font-weight: 600; color: var(--primary-color);">Car
                            Wash</button>
                        <button class="tab-btn" onclick="switchServiceTab('cook')" id="tab-cook"
                            style="padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; color: var(--text-secondary);">Cook</button>
                        <button class="tab-btn" onclick="switchServiceTab('driver')" id="tab-driver"
                            style="padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; color: var(--text-secondary);">Driver</button>
                        <button class="tab-btn" onclick="switchServiceTab('maid')" id="tab-maid"
                            style="padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; color: var(--text-secondary);">Maid</button>
                        <button class="tab-btn" onclick="switchServiceTab('pest-control')" id="tab-pest-control"
                            style="padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; color: var(--text-secondary);">Pest
                            Control</button>
                        <button class="tab-btn" onclick="switchServiceTab('deep-cleaning')" id="tab-deep-cleaning"
                            style="padding: 0.5rem 1rem; border: none; background: none; cursor: pointer; color: var(--text-secondary);">Deep
                            Cleaning</button>
                    </div>

                    <!-- Car Wash Panel -->
                    <div id="panel-car-wash" class="service-panel">
                        <div class="section-header" style="margin-bottom: 1.5rem;">
                            <h3>Car Wash Pricing</h3>
                            <button class="btn-primary" onclick="openAddPricingModal('car-wash')">
                                <i class="bi bi-plus-lg"></i> Add Pricing Rule
                            </button>
                        </div>
                        <div id="carWashPricingList" class="loading">Loading pricing...</div>
                    </div>

                    <!-- Cook Panel -->
                    <div id="panel-cook" class="service-panel" style="display: none;">
                        <div class="section-header" style="margin-bottom: 1.5rem;">
                            <h3>Cook Pricing</h3>
                            <button class="btn-primary" onclick="openAddPricingModal('cook')">
                                <i class="bi bi-plus-lg"></i> Add Pricing Rule
                            </button>
                        </div>
                        <div id="cookPricingList" class="loading">Loading pricing...</div>
                    </div>

                    <!-- Driver Panel -->
                    <div id="panel-driver" class="service-panel" style="display: none;">
                        <div class="section-header" style="margin-bottom: 1.5rem;">
                            <h3>Driver Pricing</h3>
                            <button class="btn-primary" onclick="openAddPricingModal('driver')">
                                <i class="bi bi-plus-lg"></i> Add Pricing Rule
                            </button>
                        </div>
                        <div id="driverPricingList" class="loading">Loading pricing...</div>
                    </div>

                    <!-- Maid Panel -->
                    <div id="panel-maid" class="service-panel" style="display: none;">
                        <div class="section-header" style="margin-bottom: 1.5rem;">
                            <h3>Maid Pricing</h3>
                            <button class="btn-primary" onclick="openAddPricingModal('maid')">
                                <i class="bi bi-plus-lg"></i> Add Pricing Rule
                            </button>
                        </div>
                        <div id="maidPricingList" class="loading">Loading pricing...</div>
                    </div>

                    <!-- Pest Control Panel -->
                    <div id="panel-pest-control" class="service-panel" style="display: none;">
                        <div class="section-header" style="margin-bottom: 1.5rem;">
                            <h3>Pest Control Pricing</h3>
                            <button class="btn-primary" onclick="openAddPricingModal('pest-control')">
                                <i class="bi bi-plus-lg"></i> Add Pricing Rule
                            </button>
                        </div>
                        <div id="pestControlPricingList" class="loading">Loading pricing...</div>
                    </div>

                    <!-- Deep Cleaning Panel -->
                    <div id="panel-deep-cleaning" class="service-panel" style="display: none;">
                        <div class="section-header" style="margin-bottom: 1.5rem;">
                            <h3>Deep Cleaning Pricing</h3>
                            <button class="btn-primary" onclick="openAddPricingModal('deep-cleaning')">
                                <i class="bi bi-plus-lg"></i> Add Pricing Rule
                            </button>
                        </div>
                        <div id="deepCleaningPricingList" class="loading">Loading pricing...</div>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="orders-section" class="section">
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">Order Management</h2>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Customer</th>
                                    <th>Service</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="7" class="loading">Loading orders...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="ordersPagination"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals will be inserted here -->
    <div id="modalContainer"></div>

    <script>
        const token = localStorage.getItem('authToken');
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');

        // Check if user is admin
        if (!token || userData.role !== 'admin') {
            alert('Access denied. Admin privileges required.');
            window.location.href = '/login';
        }

        let currentSection = 'dashboard';
        let currentPage = 1;

        document.addEventListener('DOMContentLoaded', () => {
            initializeAdmin();
            setupNavigation();
            loadDashboard();
            setupSearchListeners();
        });

        // Utils
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function setupSearchListeners() {
            // User Search
            const userSearch = document.getElementById('userSearch');
            if (userSearch) {
                userSearch.addEventListener('input', debounce((e) => {
                    loadUsers(1, e.target.value);
                }, 300));
            }

            // Worker Search
            const workerSearch = document.getElementById('workerSearch');
            if (workerSearch) {
                workerSearch.addEventListener('input', debounce((e) => {
                    loadWorkers(1, e.target.value);
                }, 300));
            }

            // Apartment Search
            const apartmentSearch = document.getElementById('apartmentSearch');
            if (apartmentSearch) {
                apartmentSearch.addEventListener('input', debounce((e) => {
                    loadApartments(1, e.target.value);
                }, 300));
            }
        }

        function initializeAdmin() {
            // Set admin name
            const adminName = document.getElementById('adminName');
            if (userData.fullName) {
                adminName.textContent = userData.fullName;
            }
        }

        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    switchSection(section);

                    // Update active nav
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });
        }

        function switchSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

            // Show selected section
            document.getElementById(`${section}-section`).classList.add('active');

            // Update page title
            const pageTitle = document.getElementById('pageTitle');
            pageTitle.textContent = section.charAt(0).toUpperCase() + section.slice(1);

            currentSection = section;
            currentPage = 1;

            // Load section data
            switch (section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'workers':
                    loadWorkers();
                    break;
                case 'apartments':
                    loadApartments();
                    break;
                case 'services':
                    // loadServiceCategories(); // Removed legacy category loading
                    break;
                case 'orders':
                    loadOrders();
                    break;
            }
        }

        async function makeAdminRequest(endpoint, options = {}) {
            const response = await fetch(`/api/admin${endpoint}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });

            if (response.status === 401) {
                alert('Session expired. Please login again.');
                logout();
                return null;
            }

            return response;
        }

        async function makeAPIRequest(endpoint, options = {}) {
            const response = await fetch(`/api${endpoint}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });

            return response;
        }

        async function loadDashboard() {
            try {
                const response = await makeAdminRequest('/dashboard/stats');
                if (!response?.ok) return;

                const data = await response.json();

                // Update stats
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.style.marginTop = '2rem'; // Validate spacing
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${data.stats.totalUsers}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.stats.totalWorkers}</div>
                        <div class="stat-label">Total Workers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.stats.totalOrders}</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.stats.pendingOrders}</div>
                        <div class="stat-label">Pending Orders</div>
                    </div>
                `;

                // Update recent orders
                const recentOrders = document.getElementById('recentOrders');
                if (data.recentOrders.length === 0) {
                    recentOrders.innerHTML = '<p>No recent orders</p>';
                } else {
                    recentOrders.innerHTML = data.recentOrders.map(order => {
                        const serviceName = order.bookingData?.serviceName ||
                            order.bookingData?.displayName ||
                            (order.serviceModel === 'CarWashService' ? 'Car Wash' :
                                order.serviceModel === 'MaidService' ? 'Maid Service' :
                                    order.serviceModel === 'CookService' ? 'Cook Service' :
                                        order.serviceModel === 'DriverService' ? 'Driver Service' :
                                            order.serviceModel === 'PestControlService' ? 'Pest Control' :
                                                order.serviceModel === 'DeepCleaningService' ? 'Deep Cleaning' :
                                                    'Custom Service');

                        return `
                        <div class="order-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1.2rem; background: white; border: 1px solid var(--border-light); border-radius: 12px; margin-bottom: 0.8rem; box-shadow: var(--shadow-sm); transition: transform 0.2s ease;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="background: var(--bg-light); padding: 0.8rem; border-radius: 50%; color: var(--primary-blue);">
                                    <i class="bi bi-cart-fill"></i>
                                </div>
                                <div>
                                    <strong style="color: var(--text-primary); font-size: 1rem;">${order.orderNumber}</strong>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.2rem;">
                                        ${order.user?.fullName || 'Guest'} â€¢ ${serviceName}
                                    </div>
                                    <small style="color: #999;">${new Date(order.createdAt).toLocaleDateString()} at ${new Date(order.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
                                </div>
                            </div>
                            <div>
                                <span class="status-badge status-${order.status}" style="font-size: 0.85rem;">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span>
                            </div>
                        </div>
                    `}).join('');
                }
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        async function loadUsers(page = 1, search = '') {
            try {
                const response = await makeAdminRequest(`/users?page=${page}&search=${search}`);
                if (!response?.ok) {
                    const tbody = document.getElementById('usersTableBody');
                    tbody.innerHTML = '<tr><td colspan="6">Failed to load users</td></tr>';
                    return;
                }

                const data = await response.json();

                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = data.users.map(user => `
                    <tr>
                        <td>${user.fullName}</td>
                        <td>${user.email}</td>
                        <td>${user.phone}</td>
                        <td><span class="status-badge ${user.isVerified ? 'status-verified' : 'status-unverified'}">${user.isVerified ? 'Verified' : 'Unverified'}</span></td>
                        <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn-secondary" onclick="viewUser('${user._id}')">View</button>
                            <button class="btn-secondary" onclick="editUser('${user._id}')">Edit</button>
                            <button class="btn-danger" onclick="deleteUser('${user._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');

                // Update pagination
                updatePagination('usersPagination', data.pagination, loadUsers);
            } catch (error) {
                console.error('Failed to load users:', error);
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '<tr><td colspan="6">Error loading users</td></tr>';
            }
        }

        async function loadWorkers(page = 1, search = '') {
            try {
                const response = await makeAdminRequest(`/workers?page=${page}&search=${search}`);
                if (!response?.ok) {
                    const tbody = document.getElementById('workersTableBody');
                    tbody.innerHTML = '<tr><td colspan="7">Failed to load workers</td></tr>';
                    return;
                }

                const data = await response.json();

                const tbody = document.getElementById('workersTableBody');
                tbody.innerHTML = data.workers.map(worker => `
                    <tr>
                        <td>${worker.name}</td>
                        <td>${worker.phone}</td>
                         <td>
                             ${worker.services.map(s => s.name).join(', ')}
                             ${worker.specializations && worker.specializations.length > 0 ?
                        `<div style="font-size: 0.7rem; color: #666; margin-top: 0.2rem;">
                                    ${worker.specializations.map(spec =>
                            `<strong>${spec.serviceType}:</strong> ${spec.subTypes.join(', ')}`
                        ).join(' | ')}
                                </div>` : ''}
                         </td>
                         <td>${worker.areas.map(a => a.name || a).join(', ')}</td>
                        <td>${worker.rating.toFixed(1)}/5</td>
                        <td><span class="status-badge ${worker.isActive ? 'status-active' : 'status-inactive'}">${worker.isActive ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button class="btn-secondary" onclick="editWorker('${worker._id}')">Edit</button>
                            <button class="btn-danger" onclick="deleteWorker('${worker._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');

                updatePagination('workersPagination', data.pagination, loadWorkers);
            } catch (error) {
                console.error('Failed to load workers:', error);
                const tbody = document.getElementById('workersTableBody');
                tbody.innerHTML = '<tr><td colspan="7">Error loading workers</td></tr>';
            }
        }

        async function loadApartments(page = 1, search = '') {
            try {
                const response = await makeAdminRequest(`/apartments?page=${page}&search=${search}`);
                if (!response?.ok) {
                    const tbody = document.getElementById('apartmentsTableBody');
                    tbody.innerHTML = '<tr><td colspan="6">Failed to load apartments</td></tr>';
                    return;
                }

                const data = await response.json();

                const tbody = document.getElementById('apartmentsTableBody');
                if (data.apartments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No apartments found</td></tr>';
                } else {
                    tbody.innerHTML = data.apartments.map(apt => `
                        <tr>
                            <td>${apt.name}</td>
                            <td>${apt.area}</td>
                            <td>${apt.pincode}</td>
                            <td>${apt.totalUnits}</td>
                            <td><span class="status-badge ${apt.isActive ? 'status-active' : 'status-inactive'}">${apt.isActive ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button class="btn-secondary" onclick="editApartment('${apt._id}')">Edit</button>
                                <button class="btn-danger" onclick="deleteApartment('${apt._id}')">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }

                updatePagination('apartmentsPagination', data.pagination, loadApartments);
            } catch (error) {
                console.error('Failed to load apartments:', error);
                const tbody = document.getElementById('apartmentsTableBody');
                tbody.innerHTML = '<tr><td colspan="6">Error loading apartments</td></tr>';
            }
        }

        async function loadServiceCategories() {
            return;
            try {
                const response = await makeAdminRequest('/service-categories');
                if (!response?.ok) {
                    document.getElementById('categoriesGrid').innerHTML = '<p>Failed to load service categories</p>';
                    return;
                }

                const categories = await response.json();
                const categoriesGrid = document.getElementById('categoriesGrid');
                if (categories.length === 0) {
                    categoriesGrid.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 8px;">
                            <i class="bi bi-gear" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;"></i>
                            <p>No service categories found. Create your first category to get started.</p>
                            <button class="btn-primary" onclick="openAddCategoryModal()">
                                <i class="bi bi-plus-lg"></i> Create Category
                            </button>
                        </div>
                    `;
                    return;
                }

                categoriesGrid.innerHTML = `
                    <div class="services-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem;">
                        ${categories.map(category => `
                            <div class="service-card" style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background: white; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                                <div class="card-header" style="background: ${category.color}15; padding: 1.2rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between;">
                                    <div style="display: flex; align-items: center; gap: 0.8rem;">
                                        <div style="width: 40px; height: 40px; background: ${category.color}; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                                            <i class="bi ${category.icon}" style="font-size: 1.2rem;"></i>
                                        </div>
                                        <div>
                                            <h3 style="margin: 0; font-size: 1.1rem; color: #333;">${category.name}</h3>
                                            <span class="status-badge ${category.isActive ? 'status-active' : 'status-inactive'}" style="font-size: 0.7rem; padding: 0.1rem 0.4rem;">
                                                ${category.isActive ? 'Active' : 'Inactive'}
                                            </span>
                                            ${category.viewType === 'direct' ? '<span class="status-badge status-active" style="background: #e3f2fd; color: #0d47a1; margin-left: 5px;">Direct</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="dropdown" style="position: relative;">
                                        <button onclick="toggleDropdown('cat-menu-${category._id}')" class="btn-icon" style="background: none; border: none; cursor: pointer;">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <div id="cat-menu-${category._id}" class="dropdown-menu" style="display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 100; min-width: 150px;">
                                            <a href="#" onclick="openEditCategoryModal('${category._id}'); closeDropdowns(); return false;" style="display: block; padding: 0.5rem 1rem; color: #333; text-decoration: none; border-bottom: 1px solid #eee;">
                                                <i class="bi bi-pencil" style="margin-right: 8px;"></i> Edit
                                            </a>
                                            <a href="#" onclick="toggleCategoryStatus('${category._id}', ${category.isActive}); closeDropdowns(); return false;" style="display: block; padding: 0.5rem 1rem; color: #333; text-decoration: none; border-bottom: 1px solid #eee;">
                                                <i class="bi ${category.isActive ? 'bi-toggle-off' : 'bi-toggle-on'}" style="margin-right: 8px;"></i> ${category.isActive ? 'Deactivate' : 'Activate'}
                                            </a>
                                            <a href="#" onclick="deleteCategory('${category._id}'); closeDropdowns(); return false;" style="display: block; padding: 0.5rem 1rem; color: #dc3545; text-decoration: none;">
                                                <i class="bi bi-trash" style="margin-right: 8px;"></i> Delete
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body" style="padding: 1.2rem;">
                                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem; min-height: 40px;">
                                        ${category.description || 'No description provided.'}
                                    </p>
                                    
                                    ${category.viewType === 'direct' ? `
                                        <button class="btn-primary" onclick="manageDirectService('${category._id}')" style="width: 100%; justify-content: center;">
                                            <i class="bi bi-pencil-square" style="margin-right: 5px;"></i> Manage Service Details
                                        </button>
                                    ` : `
                                        <div class="sub-services-list" style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                <h4 style="margin: 0; font-size: 0.85rem; color: #444; text-transform: uppercase; letter-spacing: 0.5px;">Sub-Services (${category.subServices ? category.subServices.length : 0})</h4>
                                            </div>
                                            <div style="max-height: 120px; overflow-y: auto;">
                                                ${category.subServices && category.subServices.length > 0 ?
                        category.subServices.map(sub => `
                                                        <div style="font-size: 0.85rem; padding: 0.3rem 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                                                            <span>${sub.name}</span>
                                                            <span style="color: ${sub.isActive ? '#28a745' : '#dc3545'}; font-size: 0.75rem;">${sub.isActive ? 'Active' : 'Inactive'}</span>
                                                        </div>
                                                    `).join('') :
                        '<p style="font-size: 0.8rem; color: #999; font-style: italic;">No sub-services yet</p>'
                    }
                                            </div>
                                        </div>
                                        
                                        <button class="btn-secondary" onclick="manageSubServices('${category._id}')" style="width: 100%; justify-content: center;">
                                            <i class="bi bi-list-check" style="margin-right: 5px;"></i> Manage Sub-Services
                                        </button>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load service categories:', error);
                document.getElementById('categoriesGrid').innerHTML = '<p>Error loading service categories</p>';
            }
        }

        function closeDropdowns() {
            document.querySelectorAll('.dropdown-menu').forEach(d => d.style.display = 'none');
        }

        // Old function placeholder to prevent errors if called elsewhere (for safety)
        function getServiceDisplayName(serviceType) {
            return serviceType;
        }

        /* 
           End of Service Management 
        */




        async function loadOrders(page = 1) {
            try {
                // Add timestamp to prevent caching
                const response = await makeAPIRequest(`/orders/admin/all?page=${page}&_t=${Date.now()}`);
                if (!response?.ok) return;

                const data = await response.json();

                const tbody = document.getElementById('ordersTableBody');
                tbody.innerHTML = data.orders.map(order => `
                    <tr>
                        <td>${order.orderNumber}</td>
                        <td>${order.user.fullName}</td>
                        <td>${order.service?.name || 'Unknown Service'}</td>
                        <td>${new Date(order.scheduledDate).toLocaleDateString()}</td>
                        <td>â‚¹${order.totalAmount}</td>
                        <td><span class="status-badge status-${order.status}">${order.status}</span></td>
                        <td>
                            <button class="btn-secondary" onclick="viewOrderDetails('${order._id}')" style="margin-right: 5px;">View Details</button>
                            <button class="btn-primary" onclick="updateOrderStatus('${order._id}')">Update Status</button>
                        </td>
                    </tr>
                `).join('');

                updatePagination('ordersPagination', data.pagination, loadOrders);
            } catch (error) {
                console.error('Failed to load orders:', error);
            }
        }

        function updatePagination(containerId, pagination, loadFunction) {
            const container = document.getElementById(containerId);
            if (!container) return;

            let paginationHTML = '';

            // Previous button
            if (pagination.page > 1) {
                paginationHTML += `<button onclick="${loadFunction.name}(${pagination.page - 1})">Previous</button>`;
            }

            // Page numbers
            for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.pages, pagination.page + 2); i++) {
                paginationHTML += `<button class="${i === pagination.page ? 'active' : ''}" onclick="${loadFunction.name}(${i})">${i}</button>`;
            }

            // Next button
            if (pagination.page < pagination.pages) {
                paginationHTML += `<button onclick="${loadFunction.name}(${pagination.page + 1})">Next</button>`;
            }

            container.innerHTML = paginationHTML;
        }

        // Modal functions
        function openWorkerModal(workerId = null) {
            const isEdit = !!workerId;
            const modalContainer = document.getElementById('modalContainer');

            modalContainer.innerHTML = `
                <div class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">${isEdit ? 'Edit' : 'Add'} Worker</h2>
                            <button class="close-modal" onclick="closeModal()">&times;</button>
                        </div>
                        <form id="workerForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="workerName">Name *</label>
                                    <input type="text" id="workerName" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="workerPhone">Phone *</label>
                                    <input type="tel" id="workerPhone" name="phone" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="workerEmail">Email</label>
                                    <input type="email" id="workerEmail" name="email">
                                </div>
                                <div class="form-group">
                                    <label for="workerAadhar">Aadhar Number</label>
                                    <input type="text" id="workerAadhar" name="aadharNumber">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="workerApartments">Service Apartments *</label>
                                <div id="areasCheckboxes" style="display: grid; grid-template-columns: 1fr; gap: 0.5rem; margin-top: 0.5rem; border: 2px solid var(--border-light); border-radius: 8px; padding: 1rem; max-height: 200px; overflow-y: auto;">
                                    Loading apartments...
                                </div>
                                <small>Select one or more apartment buildings where this worker can provide services</small>
                            </div>
                            <div class="form-group">
                                <label for="workerServices">Base Services *</label>
                                <div id="servicesCheckboxes" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
                                    Loading services...
                                </div>
                            </div>
                            <div class="form-group" style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <label style="font-weight: 600; margin-bottom: 0.8rem; display: block;">Service Specializations & Roles</label>
                                <div id="specializationsContainer">
                                    <!-- Dynamic rows for specializations -->
                                </div>
                                <button type="button" class="btn-secondary" onclick="addSpecializationRow()" style="margin-top: 0.5rem; font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                    <i class="bi bi-plus-lg"></i> Add Specialization
                                </button>
                                <small style="display: block; margin-top: 0.5rem; color: #666;">Map worker to specific roles (e.g., normal_maid, super_maid)</small>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="workerExperience">Experience (years)</label>
                                    <input type="number" id="workerExperience" name="experience" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="workerStatus">Status</label>
                                    <select id="workerStatus" name="isActive">
                                        <option value="true">Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="workerNotes">Notes</label>
                                <textarea id="workerNotes" name="notes" rows="3"></textarea>
                            </div>
                            <div style="text-align: right; margin-top: 2rem;">
                                <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn-primary">${isEdit ? 'Update' : 'Create'} Worker</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            // Load services and areas for checkboxes
            loadServicesForWorkerForm();
            loadAreasForWorkerForm();

            // If editing, load worker data
            if (isEdit) {
                loadWorkerForEdit(workerId);
            }

            // Setup form submission
            document.getElementById('workerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                submitWorkerForm(isEdit, workerId);
            });
        }

        function openApartmentModal(apartmentId = null) {
            const isEdit = !!apartmentId;
            const modalContainer = document.getElementById('modalContainer');

            modalContainer.innerHTML = `
                <div class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">${isEdit ? 'Edit' : 'Add'} Apartment</h2>
                            <button class="close-modal" onclick="closeModal()">&times;</button>
                        </div>
                        <form id="apartmentForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="apartmentName">Apartment Name *</label>
                                    <input type="text" id="apartmentName" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="apartmentArea">Area *</label>
                                    <input type="text" id="apartmentArea" name="area" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="apartmentPincode">Pincode *</label>
                                    <input type="text" id="apartmentPincode" name="pincode" pattern="[0-9]{6}" required>
                                </div>
                                <div class="form-group">
                                    <label for="apartmentUnits">Total Units</label>
                                    <input type="number" id="apartmentUnits" name="totalUnits" min="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="apartmentLandmark">Landmark</label>
                                <input type="text" id="apartmentLandmark" name="landmark">
                            </div>
                            <div class="form-group">
                                <label for="apartmentAmenities">Amenities</label>
                                <input type="text" id="apartmentAmenities" name="amenities" placeholder="e.g. Swimming Pool, Gym, Parking">
                                <small>Separate multiple amenities with commas</small>
                            </div>
                            <div class="form-group">
                                <label>Management Contact</label>
                                <div class="form-row">
                                    <div class="form-group">
                                        <input type="text" id="managementName" name="managementName" placeholder="Contact Name">
                                    </div>
                                    <div class="form-group">
                                        <input type="tel" id="managementPhone" name="managementPhone" placeholder="Contact Phone">
                                    </div>
                                </div>
                                <input type="email" id="managementEmail" name="managementEmail" placeholder="Contact Email">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="apartmentStatus">Status</label>
                                    <select id="apartmentStatus" name="isActive">
                                        <option value="true">Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="apartmentNotes">Notes</label>
                                <textarea id="apartmentNotes" name="notes" rows="3"></textarea>
                            </div>
                            <div style="text-align: right; margin-top: 2rem;">
                                <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn-primary">${isEdit ? 'Update' : 'Create'} Apartment</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            // If editing, load apartment data
            if (isEdit) {
                loadApartmentForEdit(apartmentId);
            }

            // Setup form submission
            document.getElementById('apartmentForm').addEventListener('submit', (e) => {
                e.preventDefault();
                submitApartmentForm(isEdit, apartmentId);
            });
        }

        function viewUser(id) {
            alert(`View user ${id}`);
        }

        function editUser(id) {
            openUserModal(id);
        }

        async function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                try {
                    const response = await makeAdminRequest(`/users/${id}`, {
                        method: 'DELETE'
                    });

                    if (response?.ok) {
                        alert('User deleted successfully!');
                        loadUsers(); // Refresh the users list
                    } else {
                        const error = await response?.json();
                        alert(error?.error || 'Failed to delete user');
                    }
                } catch (error) {
                    console.error('User deletion error:', error);
                    alert('Failed to delete user');
                }
            }
        }

        function editWorker(id) {
            openWorkerModal(id);
        }

        async function deleteWorker(id) {
            if (confirm('Are you sure you want to delete this worker? This action cannot be undone.')) {
                try {
                    const response = await makeAdminRequest(`/workers/${id}`, {
                        method: 'DELETE'
                    });

                    if (response?.ok) {
                        alert('Worker deleted successfully!');
                        loadWorkers(); // Refresh the workers list
                    } else {
                        const error = await response?.json();
                        alert(error?.error || 'Failed to delete worker');
                    }
                } catch (error) {
                    console.error('Worker deletion error:', error);
                    alert('Failed to delete worker');
                }
            }
        }

        function editApartment(id) {
            openApartmentModal(id);
        }

        async function deleteApartment(id) {
            if (confirm('Are you sure you want to delete this apartment? This action cannot be undone.')) {
                try {
                    const response = await makeAdminRequest(`/apartments/${id}`, {
                        method: 'DELETE'
                    });

                    if (response?.ok) {
                        alert('Apartment deleted successfully!');
                        loadApartments(); // Refresh the apartments list
                    } else {
                        const error = await response?.json();
                        alert(error?.error || 'Failed to delete apartment');
                    }
                } catch (error) {
                    console.error('Apartment deletion error:', error);
                    alert('Failed to delete apartment');
                }
            }
        }

        // === Category CRUD Functions ===

        function openAddCategoryModal() {
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.innerHTML = `
                <div class="modal active">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2 class="modal-title">Add Service Category</h2>
                            <button class="close-modal" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="addCategoryForm">
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="catName">Category Name</label>
                                    <input type="text" id="catName" name="name" required placeholder="e.g., Home Cleaning, Maintenance">
                                </div>
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="catDesc">Description</label>
                                    <textarea id="catDesc" name="description" rows="3" placeholder="Brief description of the category"></textarea>
                                </div>
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div class="form-group">
                                        <label for="catIcon">Icon (Bootstrap Icon)</label>
                                        <input type="text" id="catIcon" name="icon" value="bi-gear-fill" placeholder="bi-..." onchange="document.getElementById('iconPreview').className = 'bi ' + this.value">
                                        <div style="margin-top: 5px;">Preview: <i id="iconPreview" class="bi bi-gear-fill" style="font-size: 1.2rem;"></i></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="catColor">Color</label>
                                        <input type="color" id="catColor" name="color" value="#007bff" style="height: 40px; width: 100%;">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label for="catViewType">View Type</label>
                                    <select id="catViewType" name="viewType" class="form-control" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="hierarchical">Hierarchical (Has Sub-Services & Categories)</option>
                                        <option value="direct">Direct (Single Service with Options)</option>
                                    </select>
                                    <small class="text-muted" style="display: block; margin-top: 5px;">
                                        Select <b>Direct</b> if this category has no sub-services (e.g. "Plumbing" directly shows options). Select <b>Hierarchical</b> for categories like "Cleaning" -> "Sofa", "Kitchen".
                                    </small>
                                </div>
                                <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                                    <button type="submit" class="btn-primary">Create Category</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('addCategoryForm').addEventListener('submit', createNewCategory);
        }

        async function createNewCategory(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                icon: formData.get('icon'),
                color: formData.get('color'),
                viewType: formData.get('viewType') || 'hierarchical',
                isActive: true
            };

            try {
                const response = await makeAdminRequest('/service-categories', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                if (response?.ok) {
                    alert('Category created successfully!');
                    closeModal();
                    loadServiceCategories();
                } else {
                    const error = await response?.json();
                    alert(error?.error || 'Failed to create category');
                }
            } catch (error) {
                console.error('Create category error:', error);
                alert('Failed to create category');
            }
        }

        function openEditCategoryModal(id) {
            // Fetch category details first
            makeAdminRequest(`/service-categories/${id}`)
                .then(res => res.json())
                .then(category => {
                    const modalContainer = document.getElementById('modalContainer');
                    modalContainer.innerHTML = `
                        <div class="modal active">
                            <div class="modal-content" style="max-width: 500px;">
                                <div class="modal-header">
                                    <h2 class="modal-title">Edit Category</h2>
                                    <button class="close-modal" onclick="closeModal()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <form id="editCategoryForm">
                                        <div class="form-group" style="margin-bottom: 1rem;">
                                            <label>Category Name</label>
                                            <input type="text" name="name" required value="${category.name}">
                                        </div>
                                        <div class="form-group" style="margin-bottom: 1rem;">
                                            <label>Description</label>
                                            <textarea name="description" rows="3">${category.description || ''}</textarea>
                                        </div>
                                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                            <div class="form-group">
                                                <label>Icon</label>
                                                <input type="text" name="icon" value="${category.icon || 'bi-gear-fill'}">
                                            </div>
                                            <div class="form-group">
                                                <label>Color</label>
                                                <input type="color" name="color" value="${category.color || '#007bff'}" style="height: 40px; width: 100%;">
                                            </div>
                                        </div>
                                        <div class="form-group" style="margin-bottom: 1.5rem;">
                                            <label>View Type</label>
                                            <select name="viewType" class="form-control" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                                <option value="hierarchical" ${category.viewType !== 'direct' ? 'selected' : ''}>Hierarchical (Has Sub-Services)</option>
                                                <option value="direct" ${category.viewType === 'direct' ? 'selected' : ''}>Direct (Single Service)</option>
                                            </select>
                                        </div>
                                        <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                                            <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                                            <button type="submit" class="btn-primary">Update Category</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    `;

                    document.getElementById('editCategoryForm').addEventListener('submit', (e) => updateCategory(e, id));
                })
                .catch(err => {
                    console.error('Failed to load category details:', err);
                    alert('Failed to load category details');
                });
        }

        async function updateCategory(e, id) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                icon: formData.get('icon'),
                color: formData.get('color'),
                viewType: formData.get('viewType')
            };

            try {
                const response = await makeAdminRequest(`/service-categories/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                if (response?.ok) {
                    alert('Category updated successfully!');
                    closeModal();
                    loadServiceCategories();
                } else {
                    const error = await response?.json();
                    alert(error?.error || 'Failed to update category');
                }
            } catch (error) {
                console.error('Update category error:', error);
                alert('Failed to update category');
            }
        }

        async function deleteCategory(id) {
            if (confirm('Are you sure? This will delete the category AND all its sub-services. This action cannot be undone.')) {
                try {
                    const response = await makeAdminRequest(`/service-categories/${id}`, {
                        method: 'DELETE'
                    });

                    if (response?.ok) {
                        alert('Category deleted successfully!');
                        loadServiceCategories();
                    } else {
                        const error = await response?.json();
                        alert(error?.error || 'Failed to delete category');
                    }
                } catch (error) {
                    console.error('Delete category error:', error);
                    alert('Failed to delete category');
                }
            }
        }

        async function toggleCategoryStatus(id, currentStatus) {
            try {
                const response = await makeAdminRequest(`/service-categories/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ isActive: !currentStatus })
                });

                if (response?.ok) {
                    loadServiceCategories();
                } else {
                    alert('Failed to update status');
                }
            } catch (error) {
                console.error('Toggle status error:', error);
                alert('Failed to update status');
            }
        }


        // === Sub-Service Management ===

        async function manageSubServices(categoryId) {
            try {
                const response = await makeAdminRequest(`/service-categories/${categoryId}`);
                if (!response.ok) throw new Error('Failed to load category');

                const category = await response.json();
                const modalContainer = document.getElementById('modalContainer');

                modalContainer.innerHTML = `
                    <div class="modal active">
                        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                            <div class="modal-header">
                                <h2 class="modal-title">Manage Sub-Services: ${category.name}</h2>
                                <button class="close-modal" onclick="closeModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                    <p style="color: #666; margin: 0;">Add and manage sub-services (e.g., 1 BHK Cleaning, Sofa Cleaning).</p>
                                    <button class="btn-primary" onclick="openAddSubServiceModal('${category._id}')">
                                        <i class="bi bi-plus-lg"></i> Add Sub-Service
                                    </button>
                                </div>
                                
                                <div id="subServicesList">
                                    ${category.subServices && category.subServices.length > 0 ? `
                                        <div class="table-responsive">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Name</th>
                                                        <th>Default Price</th>
                                                        <th>Duration</th>
                                                        <th>Status</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${category.subServices.map(sub => `
                                                        <tr>
                                                            <td>
                                                                <div style="font-weight: 500;">${sub.name}</div>
                                                                <small style="color: #888;">${sub.description || ''}</small>
                                                            </td>
                                                            <td>â‚¹${sub.pricing?.basePrice || 0}</td>
                                                            <td>${sub.timings?.duration || 60}m</td>
                                                            <td>
                                                                <span class="status-badge ${sub.isActive ? 'status-active' : 'status-inactive'}">
                                                                    ${sub.isActive ? 'Active' : 'Inactive'}
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <button class="btn-icon" onclick="openEditSubServiceModal('${category._id}', '${sub._id}')" title="Edit">
                                                                    <i class="bi bi-pencil"></i>
                                                                </button>
                                                                <button class="btn-icon" onclick="deleteSubService('${category._id}', '${sub._id}')" title="Delete" style="color: #dc3545;">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    ` : '<div style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 8px;">No sub-services yet.</div>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error(error);
                alert('Failed to load category details');
            }
        }

        function openAddSubServiceModal(categoryId) {
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.innerHTML = `
                <div class="modal active" id="subServiceModal">
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2 class="modal-title">Add Sub-Service</h2>
                            <button class="close-modal" onclick="manageSubServices('${categoryId}')" title="Back to list"><i class="bi bi-arrow-left"></i> Back</button>
                        </div>
                        <div class="modal-body">
                            <form id="subServiceForm">
                                <!-- Basic Info -->
                                <h4 style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-bottom: 1rem; color: var(--primary-color);">Basic Info</h4>
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>Name</label>
                                        <input type="text" name="name" required placeholder="e.g. Full Home Cleaning">
                                    </div>
                                    <div class="form-group">
                                        <label>Icon (Bootstrap)</label>
                                        <input type="text" name="icon" placeholder="bi-..." value="bi-check-circle">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea name="description" rows="2" placeholder="Detail description of the service"></textarea>
                                </div>
                                
                                <!--Pricing -->
                                <h4 style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin: 1.5rem 0 1rem; color: var(--primary-color);">Default Pricing & Duration</h4>
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>Base Price (â‚¹)</label>
                                        <input type="number" name="basePrice" required min="0" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Discounted Price (â‚¹)</label>
                                        <input type="number" name="discountedPrice" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Duration (min)</label>
                                        <input type="number" name="duration" required min="15" step="15" value="60">
                                    </div>
                                </div>
                                
                                <!-- Time Slots (e.g. for Cook) -->
                                <h4 style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin: 1.5rem 0 1rem; color: var(--primary-color);">Time Slots (Optional)</h4>
                                <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">Add specific time slots (e.g. Breakfast) if this service isn't just hourly.</p>
                                <div id="timeSlotsContainer"></div>
                                <button type="button" class="btn-secondary" onclick="addTimeSlot()" style="margin-top: 0.5rem;">
                                    <i class="bi bi-clock"></i> Add Time Slot
                                </button>

                                <!--Options -->
                                <h4 style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin: 1.5rem 0 1rem; color: var(--primary-color);">Variations (e.g. BHK Options)</h4>
                                <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">Add options if this service has variations (e.g. 1 BHK, 2 BHK) with different prices.</p>
                                <div id="optionsContainer"></div>
                                <button type="button" class="btn-secondary" onclick="addSubServiceOption()" style="margin-top: 0.5rem;">
                                    <i class="bi bi-plus"></i> Add Option
                                </button>

                                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                                    <button type="button" class="btn-secondary" onclick="manageSubServices('${categoryId}')">Cancel</button>
                                    <button type="submit" class="btn-primary">Add Sub-Service</button>
                                </div>
                            </form >
                        </div >
                    </div >
                </div >
            `;

            document.getElementById('subServiceForm').addEventListener('submit', (e) => createSubService(e, categoryId));
        }

        function addTimeSlot() {
            const container = document.getElementById('timeSlotsContainer');
            const div = document.createElement('div');
            div.className = 'slot-row';
            div.style.cssText = 'display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee;';
            div.innerHTML = `
                <div style="flex: 2;">
                    <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">Slot Label</label>
                    <input type="text" name="slotLabel[]" placeholder="e.g. Breakfast" required style="font-size: 0.9rem;">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">Start Time</label>
                    <input type="time" name="slotStart[]" required style="font-size: 0.9rem;">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">End Time</label>
                    <input type="time" name="slotEnd[]" required style="font-size: 0.9rem;">
                </div>
                <button type="button" class="btn-icon" onclick="this.parentElement.remove()" style="color: #dc3545; height: 38px; align-self: flex-end; margin-bottom: 2px;">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            container.appendChild(div);
        }

        function addSubServiceOption() {
            const container = document.getElementById('optionsContainer');
            const id = Date.now();
            const div = document.createElement('div');
            div.className = 'option-row';
            div.style.cssText = 'display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee;';
            div.innerHTML = `
                <div style="flex: 1;">
                    <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">Group (Optional)</label>
                    <input type="text" name="optionGroup[]" placeholder="e.g. Sedan" value="General" style="font-size: 0.9rem;">
                </div>
                <div style="flex: 2;">
                    <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">Option Name</label>
                    <input type="text" name="optionName[]" required placeholder="e.g. 1BHK" style="font-size: 0.9rem;">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">Price (â‚¹)</label>
                    <input type="number" name="optionPrice[]" required min="0" style="font-size: 0.9rem;">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">Duration (min)</label>
                    <input type="number" name="optionDuration[]" required min="15" value="60" style="font-size: 0.9rem;">
                </div>
                <button type="button" class="btn-icon" onclick="this.parentElement.remove()" style="color: #dc3545; height: 38px; align-self: flex-end; margin-bottom: 2px;">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            container.appendChild(div);
        }

        async function createSubService(e, categoryId) {
            e.preventDefault();
            const formData = new FormData(e.target);

            // Collect options
            const options = [];
            const optionGroups = formData.getAll('optionGroup[]');
            const optionNames = formData.getAll('optionName[]');
            const optionPrices = formData.getAll('optionPrice[]');
            const optionDurations = formData.getAll('optionDuration[]');

            for (let i = 0; i < optionNames.length; i++) {
                options.push({
                    optionType: 'variant',
                    group: optionGroups[i] || 'General',
                    optionLabel: optionNames[i],
                    optionValue: optionNames[i].toLowerCase().replace(/[^a-z0-9]/g, '_'),
                    price: parseFloat(optionPrices[i]),
                    duration: parseInt(optionDurations[i]) || 60
                });
            }

            // Collect Time Slots
            const timeSlots = [];
            const slotLabels = formData.getAll('slotLabel[]');
            const slotStarts = formData.getAll('slotStart[]');
            const slotEnds = formData.getAll('slotEnd[]');

            for (let i = 0; i < slotLabels.length; i++) {
                if (slotLabels[i] && slotStarts[i]) {
                    timeSlots.push({
                        label: slotLabels[i],
                        startTime: slotStarts[i],
                        endTime: slotEnds[i]
                    });
                }
            }

            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                icon: formData.get('icon'),
                pricing: {
                    basePrice: parseFloat(formData.get('basePrice')),
                    discountedPrice: formData.get('discountedPrice') ? parseFloat(formData.get('discountedPrice')) : null
                },
                timings: {
                    duration: parseInt(formData.get('duration')),
                    timeSlots: timeSlots
                },
                options: options,
                isActive: true
            };

            try {
                const response = await makeAdminRequest(`/ service - categories / ${categoryId}/sub-services`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                if (response?.ok) {
                    alert('Sub-service created successfully!');
                    manageSubServices(categoryId); // Return to list
                } else {
                    const error = await response?.json();
                    alert(error?.error || 'Failed to create sub-service');
                }
            } catch (error) {
                console.error('Create sub-service error:', error);
                alert('Failed to create sub-service');
            }
        }

        async function deleteSubService(categoryId, subServiceId) {
            if (confirm('Are you sure you want to delete this sub-service?')) {
                try {
                    const response = await makeAdminRequest(`/service-categories/${categoryId}/sub-services/${subServiceId}`, {
                        method: 'DELETE'
                    });

                    if (response?.ok) {
                        manageSubServices(categoryId);
                    } else {
                        alert('Failed to delete sub-service');
                    }
                } catch (error) {
                    console.error('Delete sub-service error:', error);
                    alert('Failed to delete sub-service');
                }
            }
        }

        function openEditSubServiceModal(categoryId, subServiceId) {
            // First fetch the category to get sub-service details
            makeAdminRequest(`/service-categories/${categoryId}`)
                .then(res => res.json())
                .then(category => {
                    const subService = category.subServices.find(s => s._id === subServiceId);
                    if (!subService) {
                        alert('Sub-service not found');
                        return;
                    }

                    const isDirect = category.viewType === 'direct';
                    const backAction = isDirect ? 'closeModal()' : `manageSubServices('${categoryId}')`;
                    const title = isDirect ? 'Edit Service Details' : 'Edit Sub-Service';

                    const modalContainer = document.getElementById('modalContainer');
                    modalContainer.innerHTML = `
                        <div class="modal active" id="subServiceModal">
                            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                                <div class="modal-header">
                                    <h2 class="modal-title">${title}</h2>
                                    <button class="close-modal" onclick="${backAction}">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <form id="editSubServiceForm">
                                        <!-- Basic Info -->
                                        <h4 style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-bottom: 1rem; color: var(--primary-color);">Basic Info</h4>
                                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                            <div class="form-group">
                                                <label>Name</label>
                                                <input type="text" name="name" required value="${subService.name}" placeholder="Service Name">
                                            </div>
                                            <div class="form-group">
                                                <label>Icon</label>
                                                <input type="text" name="icon" value="${subService.icon || 'bi-check-circle'}" placeholder="bi-...">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Description</label>
                                            <textarea name="description" rows="2">${subService.description || ''}</textarea>
                                        </div>
                                        
                                        <!-- Pricing -->
                                        <h4 style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin: 1.5rem 0 1rem; color: var(--primary-color);">Pricing & Duration</h4>
                                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                            <div class="form-group">
                                                <label>Base Price (â‚¹)</label>
                                                <input type="number" name="basePrice" required min="0" value="${subService.pricing?.basePrice || 0}">
                                            </div>
                                            <div class="form-group">
                                                <label>Discounted Price (â‚¹)</label>
                                                <input type="number" name="discountedPrice" min="0" value="${subService.pricing?.discountedPrice || ''}">
                                            </div>
                                            <div class="form-group">
                                                <label>Duration (min)</label>
                                                <input type="number" name="duration" required min="15" step="15" value="${subService.timings?.duration || 60}">
                                            </div>
                                        </div>

                                        <!-- Time Slots -->
                                        <h4 style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin: 1.5rem 0 1rem; color: var(--primary-color);">Time Slots</h4>
                                        <div id="timeSlotsContainer">
                                            ${subService.timings?.timeSlots ? subService.timings.timeSlots.map(slot => `
                                                <div class="slot-row" style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee;">
                                                    <div style="flex: 2;">
                                                        <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">Slot Label</label>
                                                        <input type="text" name="slotLabel[]" value="${slot.label || ''}" required placeholder="e.g. Breakfast" style="font-size: 0.9rem;">
                                                    </div>
                                                    <div style="flex: 1;">
                                                        <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">Start Time</label>
                                                        <input type="time" name="slotStart[]" value="${slot.startTime || ''}" required style="font-size: 0.9rem;">
                                                    </div>
                                                    <div style="flex: 1;">
                                                        <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">End Time</label>
                                                        <input type="time" name="slotEnd[]" value="${slot.endTime || ''}" required style="font-size: 0.9rem;">
                                                    </div>
                                                    <button type="button" class="btn-icon" onclick="this.parentElement.remove()" style="color: #dc3545; height: 38px; align-self: flex-end; margin-bottom: 2px;">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            `).join('') : ''}
                                        </div>
                                        <button type="button" class="btn-secondary" onclick="addTimeSlot()" style="margin-top: 0.5rem;">
                                            <i class="bi bi-clock"></i> Add Time Slot
                                        </button>

                                        <!-- Options -->
                                        <h4 style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin: 1.5rem 0 1rem; color: var(--primary-color);">Options (Variants)</h4>
                                        <div id="optionsContainer">
                                            ${subService.options ? subService.options.map((opt, idx) => `
                                                <div class="option-row" id="opt-${idx}-${Date.now()}" style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee;">
                                                    <div style="flex: 1;">
                                                        <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">Group (Optional)</label>
                                                        <input type="text" name="optionGroup[]" value="${opt.group || 'General'}" placeholder="e.g. Sedan" style="font-size: 0.9rem;">
                                                    </div>
                                                    <div style="flex: 2;">
                                                        <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">Option Name</label>
                                                        <input type="text" name="optionName[]" value="${opt.optionLabel || opt.name || ''}" required style="font-size: 0.9rem;">
                                                    </div>
                                                    <div style="flex: 1;">
                                                        <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">Price (â‚¹)</label>
                                                        <input type="number" name="optionPrice[]" value="${opt.price}" required min="0" style="font-size: 0.9rem;">
                                                    </div>
                                                    <div style="flex: 1;">
                                                        <label style="font-size: 0.85rem; margin-bottom: 3px; display: block;">Duration (min)</label>
                                                        <input type="number" name="optionDuration[]" value="${opt.duration || 60}" required min="15" style="font-size: 0.9rem;">
                                                    </div>
                                                    <button type="button" class="btn-icon" onclick="this.parentElement.remove()" style="color: #dc3545; height: 38px; align-self: flex-end; margin-bottom: 2px;" title="Remove Option">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            `).join('') : ''}
                                        </div>
                                        <button type="button" class="btn-secondary" onclick="addSubServiceOption()" style="margin-top: 0.5rem;">
                                            <i class="bi bi-plus"></i> Add Option
                                        </button>

                                        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                                            <button type="button" class="btn-secondary" onclick="${backAction}">Cancel</button>
                                            <button type="submit" class="btn-primary">Update ${isDirect ? 'Service' : 'Sub-Service'}</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    `;

                    document.getElementById('editSubServiceForm').addEventListener('submit', (e) => updateSubService(e, categoryId, subServiceId, isDirect));
                })
                .catch(err => {
                    console.error(err);
                    alert('Failed to load sub-service details');
                });
        }

        async function updateSubService(e, categoryId, subServiceId, isDirect = false) {
            e.preventDefault();
            const formData = new FormData(e.target);

            // Collect options
            const options = [];
            const optionGroups = formData.getAll('optionGroup[]');
            const optionNames = formData.getAll('optionName[]');
            const optionPrices = formData.getAll('optionPrice[]');
            const optionDurations = formData.getAll('optionDuration[]');

            for (let i = 0; i < optionNames.length; i++) {
                options.push({
                    optionType: 'variant',
                    group: optionGroups[i] || 'General',
                    optionLabel: optionNames[i],
                    optionValue: optionNames[i].toLowerCase().replace(/[^a-z0-9]/g, '_'),
                    price: parseFloat(optionPrices[i]),
                    duration: parseInt(optionDurations[i]) || 60
                });
            }

            // Collect Time Slots
            const timeSlots = [];
            const slotLabels = formData.getAll('slotLabel[]');
            const slotStarts = formData.getAll('slotStart[]');
            const slotEnds = formData.getAll('slotEnd[]');

            for (let i = 0; i < slotLabels.length; i++) {
                if (slotLabels[i] && slotStarts[i]) {
                    timeSlots.push({
                        label: slotLabels[i],
                        startTime: slotStarts[i],
                        endTime: slotEnds[i]
                    });
                }
            }

            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                icon: formData.get('icon'),
                pricing: {
                    basePrice: parseFloat(formData.get('basePrice')),
                    discountedPrice: formData.get('discountedPrice') ? parseFloat(formData.get('discountedPrice')) : null
                },
                timings: {
                    duration: parseInt(formData.get('duration')),
                    timeSlots: timeSlots
                },
                options: options
            };

            try {
                const response = await makeAdminRequest(`/service-categories/${categoryId}/sub-services/${subServiceId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                if (response?.ok) {
                    alert('Sub-service updated successfully!');
                    if (isDirect) {
                        closeModal();
                        loadServiceCategories();
                    } else {
                        manageSubServices(categoryId);
                    }
                } else {
                    const error = await response?.json();
                    alert(error?.error || 'Failed to update sub-service');
                }
            } catch (error) {
                console.error('Update sub-service error:', error);
                alert('Failed to update sub-service');
            }
        }

        async function manageDirectService(categoryId) {
            try {
                const response = await makeAdminRequest(`/service-categories/${categoryId}`);
                const category = await response.json();

                if (category.subServices && category.subServices.length > 0) {
                    // Edit the first sub-service
                    // We assume for 'direct' viewType there is effectively one main sub-service
                    openEditSubServiceModal(categoryId, category.subServices[0]._id);
                } else {
                    // Create a default sub-service automatically
                    await createDefaultDirectSubService(category);
                }
            } catch (error) {
                console.error('Error managing direct service:', error);
                alert('Failed to load service details');
            }
        }

        async function createDefaultDirectSubService(category) {
            const data = {
                name: category.name,
                description: category.description,
                icon: category.icon,
                pricing: { basePrice: 0 },
                timings: { duration: 60 },
                isActive: true
            };

            try {
                const response = await makeAdminRequest(`/service-categories/${category._id}/sub-services`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                if (response?.ok) {
                    // Recursive call to open the edit modal now that it exists
                    manageDirectService(category._id);
                } else {
                    const error = await response?.json();
                    alert(error?.error || 'Failed to initialize direct service');
                }
            } catch (error) {
                console.error('Error creating default sub-service:', error);
                alert('Failed to initialize direct service');
            }
        }

        // Helper function to get current service type from the modal context
        function getCurrentServiceType() {
            const modalTitle = document.querySelector('.modal-title')?.textContent || '';
            if (modalTitle.includes('Maid')) return 'maid';
            if (modalTitle.includes('Cook')) return 'cook';
            if (modalTitle.includes('Driver')) return 'driver';
            if (modalTitle.includes('Car Wash')) return 'carwash';
            if (modalTitle.includes('Deep Cleaning')) return 'deepcleaning';
            if (modalTitle.includes('Pest Control')) return 'pestcontrol';
            return 'maid'; // fallback
        }

        // Refresh just the pricing list without rebuilding the entire modal
        async function refreshPricingListOnly(serviceType) {
            try {
                const response = await makeAdminRequest(`/services/${serviceType}`);
                const service = await response.json();

                const pricingListElement = document.getElementById('pricingItemsList');
                if (pricingListElement && service) {
                    pricingListElement.innerHTML = service.pricing?.map((item, index) => `
                        <div class="pricing-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; margin: 0.5rem 0; background: #f8f9fa; border-radius: 4px;">
                            <div>
                                <strong>${item.displayName}</strong>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    ${item.additionalRate ?
                            `Base: â‚¹${item.baseRate} + â‚¹${item.additionalRate}/additional hour (Min: ${item.minHours || 1}h)` :
                            `â‚¹${item.baseRate} â€¢ Fixed price`
                        }
                                </div>
                                ${item.apartmentNames?.length > 0 ? `<div style="font-size: 0.85rem; color: #007bff;">Apartments: ${item.apartmentNames.join(', ')}</div>` : '<div style="font-size: 0.85rem; color: #28a745;">Available for all apartments</div>'}
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">${item.description}</div>
                            </div>
                            <div>
                                <button type="button" class="btn-secondary" onclick="editPricingItem('${serviceType}', ${index})" style="margin-right: 0.5rem; padding: 0.3rem 0.8rem; font-size: 0.85rem;">Edit</button>
                                <button type="button" class="btn-danger" onclick="deletePricingItem('${serviceType}', ${index})" style="padding: 0.3rem 0.8rem; font-size: 0.85rem;">Delete</button>
                            </div>
                        </div>
                    `).join('') || '<p>No pricing items yet. Add one below.</p>';

                    // Update the count in the header
                    const countElement = pricingListElement.previousElementSibling;
                    if (countElement && countElement.tagName === 'H4') {
                        countElement.textContent = `Current Pricing (${service.pricing?.length || 0} items)`;
                    }
                }
            } catch (error) {
                console.error('Failed to refresh pricing list:', error);
            }
        }

        async function loadServiceForPricingEdit(serviceType) {
            try {
                const response = await makeAdminRequest(`/services/${serviceType}`);
                if (!response?.ok) {
                    document.getElementById('servicePricingContent').innerHTML = '<p>Service not found</p>';
                    return;
                }

                const service = await response.json();

                document.getElementById('servicePricingContent').innerHTML = `
                    <div class="service-pricing-editor">
                        <div class="form-group">
                            <h3>${getServiceDisplayName(serviceType)}</h3>
                            <p style="color: var(--text-secondary);">${service.description || 'Professional service'}</p>
                        </div>
                        
                        <div class="service-settings" style="margin-bottom: 2rem;">
                            <h4>Service Settings</h4>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <strong>Operating Hours:</strong><br>
                                        ${service.settings?.operatingHours?.startTime || '06:00'} - ${service.settings?.operatingHours?.endTime || '19:00'}
                                    </div>
                                    <div>
                                        <strong>Default Rates:</strong><br>
                                        Base: â‚¹${service.settings?.defaultBaseRate || 249}<br>
                                        Additional: â‚¹${service.settings?.defaultAdditionalRate || 200}/hour
                                    </div>
                                    <div>
                                        <button type="button" class="btn-secondary" onclick="editServiceSettings('${serviceType}')" style="padding: 0.4rem 1rem; font-size: 0.85rem;">Edit Settings</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pricing-list">
                            <h4>Current Pricing (${service.pricing?.length || 0} items)</h4>
                            <div id="pricingItemsList" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 1rem; margin-bottom: 2rem;">
                                ${service.pricing?.map((item, index) => `
                                    <div class="pricing-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; margin: 0.5rem 0; background: #f8f9fa; border-radius: 4px;">
                                        <div>
                                            <strong>${item.displayName}</strong>
                                            <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                                ${item.additionalRate ?
                        `Base: â‚¹${item.baseRate} + â‚¹${item.additionalRate}/additional hour (Min: ${item.minHours || 1}h)` :
                        `â‚¹${item.baseRate} â€¢ Fixed price`
                    }
                                            </div>
                                            ${item.apartmentNames?.length > 0 ? `<div style="font-size: 0.85rem; color: #007bff;">Apartments: ${item.apartmentNames.join(', ')}</div>` : '<div style="font-size: 0.85rem; color: #28a745;">Available for all apartments</div>'}
                                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${item.description}</div>
                                        </div>
                                        <div>
                                            <button type="button" class="btn-secondary" onclick="editPricingItem('${serviceType}', ${index})" style="margin-right: 0.5rem; padding: 0.3rem 0.8rem; font-size: 0.85rem;">Edit</button>
                                            <button type="button" class="btn-danger" onclick="deletePricingItem('${serviceType}', ${index})" style="padding: 0.3rem 0.8rem; font-size: 0.85rem;">Delete</button>
                                        </div>
                                    </div>
                                `).join('') || '<p>No pricing items configured</p>'}
                            </div>
                        </div>
                        
                        <div class="add-pricing-item">
                            <h4>Add New Pricing Item</h4>
                            <form id="addPricingForm">
                                <div class="form-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="form-group">
                                        <label for="displayName">Display Name</label>
                                        <input type="text" id="displayName" name="displayName" placeholder="e.g., Normal Maid Service" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="baseRate">Base Rate (â‚¹)</label>
                                        <input type="number" id="baseRate" name="baseRate" min="0" step="1" value="249" required>
                                        <small>Price for first hour</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="additionalRate">Additional Rate (â‚¹)</label>
                                        <input type="number" id="additionalRate" name="additionalRate" min="0" step="1" value="200">
                                        <small>Rate per extra hour</small>
                                    </div>
                                </div>
                                
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="form-group">
                                        <label for="minHours">Min Hours</label>
                                        <input type="number" id="minHours" name="minHours" min="0.5" step="0.5" value="1">
                                    </div>
                                    <div class="form-group">
                                        <label for="apartmentSelection">Target Apartments</label>
                                        <div style="margin-bottom: 0.5rem;">
                                            <button type="button" id="loadApartments" style="background: #007bff; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 3px; font-size: 0.85rem; margin-right: 0.5rem;">Load Apartments</button>
                                            <button type="button" id="selectAllApartments" style="background: #28a745; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 3px; font-size: 0.85rem; margin-right: 0.5rem;">Select All</button>
                                            <button type="button" id="clearApartments" style="background: #dc3545; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 3px; font-size: 0.85rem;">Clear All</button>
                                        </div>
                                        <select id="apartmentSelection" name="apartmentSelection" multiple style="height: 100px; width: 100%;">
                                            <!-- Apartment options will be loaded dynamically -->
                                        </select >
            <small>Hold Ctrl/Cmd to select multiple. Empty selection = All apartments</small>
                                    </div >
                                </div >
                                
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="description">Description</label>
                                    <input type="text" id="description" name="description" placeholder="Brief description of the service">
                                </div>
                                <div class="form-group" style="margin-bottom: 2rem;">
                                    <label for="serviceVariant">Service Variant (for system)</label>
                                    <input type="text" id="serviceVariant" name="serviceVariant" placeholder="e.g., normal_maid_2bhk_hourly" required>
                                    <small>Unique identifier for this pricing option (no spaces, use underscores)</small>
                                </div>
                                <button type="submit" class="btn-secondary">Add Pricing Item</button>
                            </form >
                        </div >

            <div style="text-align: right; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                <button type="button" class="btn-secondary" onclick="closeModal()">Close</button>
            </div>
                    </div >
            `;

                // Add event listener for the form
                document.getElementById('addPricingForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    addPricingItem(serviceType);
                });

            } catch (error) {
                console.error('Failed to load service:', error);
                document.getElementById('servicePricingContent').innerHTML = '<p>Failed to load service data</p>';
            }
        }

        async function addPricingItem(serviceType) {
            try {
                const formData = new FormData(document.getElementById('addPricingForm'));

                // Get selected apartments
                const apartmentSelect = document.getElementById('apartmentSelection');
                const selectedOptions = Array.from(apartmentSelect.selectedOptions);
                const isAllApartments = selectedOptions.length === 0; // Empty selection = All apartments

                const newPricingItem = {
                    serviceVariant: formData.get('serviceVariant') || generateServiceVariant(formData.get('displayName')),
                    displayName: formData.get('displayName'),
                    baseRate: parseInt(formData.get('baseRate')) || 249,
                    additionalRate: parseInt(formData.get('additionalRate')) || 0,
                    minHours: parseFloat(formData.get('minHours')) || 1,
                    apartmentIds: isAllApartments ? [] : selectedOptions.map(opt => opt.value),
                    apartmentNames: isAllApartments ? [] : selectedOptions.map(opt => opt.text),
                    description: formData.get('description') || '',
                    operatingHours: {
                        startTime: '06:00',
                        endTime: '19:00'
                    },
                    isActive: true
                };

                const response = await makeAdminRequest(`/ services / ${serviceType} /pricing/add`, {
                    method: 'POST',
                    body: JSON.stringify(newPricingItem)
                });

                if (response?.ok) {
                    // Clear the form but keep modal open
                    document.getElementById('addPricingForm').reset();

                    // Set default values back
                    document.getElementById('baseRate').value = '249';
                    document.getElementById('additionalRate').value = '200';
                    document.getElementById('minHours').value = '1';

                    // Refresh pricing list and apartment options without closing modal
                    await refreshPricingListOnly(serviceType);
                    await loadApartmentsForPricing(serviceType); // This will smart-filter apartments

                    alert('Pricing item added successfully!');
                } else {
                    const error = await response?.json();
                    alert(error?.error || 'Failed to add pricing item');
                }
            } catch (error) {
                console.error('Add pricing item error:', error);
                alert('Failed to add pricing item');
            }
        }

        function editServiceSettings(serviceType) {
            const modalContainer = document.getElementById('modalContainer');

            modalContainer.innerHTML = `
            < div class="modal active" >
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2 class="modal-title">Edit ${getServiceDisplayName(serviceType)} Settings</h2>
                        <button class="close-modal" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="serviceSettingsForm">
                            <h4>Operating Hours</h4>
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                                <div class="form-group">
                                    <label for="startTime">Start Time</label>
                                    <input type="time" id="startTime" name="startTime" value="06:00" required>
                                </div>
                                <div class="form-group">
                                    <label for="endTime">End Time</label>
                                    <input type="time" id="endTime" name="endTime" value="19:00" required>
                                </div>
                            </div>

                            <h4>Service Default Rates (â‚¹)</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                                Set default base and additional rates for this ${serviceType} service. You can create apartment-specific pricing in the pricing items above.
                            </p>
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                                <div class="form-group">
                                    <label for="defaultBaseRate">Default Base Rate (1st hour)</label>
                                    <input type="number" id="defaultBaseRate" name="defaultBaseRate" value="" min="0" step="10">
                                        <small>Price for the first hour</small>
                                </div>
                                <div class="form-group">
                                    <label for="defaultAdditionalRate">Default Additional Rate (per extra hour)</label>
                                    <input type="number" id="defaultAdditionalRate" name="defaultAdditionalRate" value="" min="0" step="10">
                                        <small>Added for each additional hour</small>
                                </div>
                            </div>

                            <div style="text-align: right; margin-top: 2rem;">
                                <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn-primary">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
                </div >
            `;

            document.getElementById('serviceSettingsForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveServiceSettings(serviceType);
            });

            // Load current service settings
            loadCurrentServiceSettings(serviceType);
        }

        async function loadCurrentServiceSettings(serviceType) {
            try {
                const response = await makeAdminRequest(`/ services / ${serviceType} `);
                const service = await response.json();

                if (service) {
                    // Populate operating hours
                    document.getElementById('startTime').value = service.settings?.operatingHours?.startTime || '06:00';
                    document.getElementById('endTime').value = service.settings?.operatingHours?.endTime || '19:00';

                    // Populate default rates
                    document.getElementById('defaultBaseRate').value = service.settings?.defaultBaseRate || '';
                    document.getElementById('defaultAdditionalRate').value = service.settings?.defaultAdditionalRate || '';
                }
            } catch (error) {
                console.error('Failed to load service settings:', error);
            }
        }

        async function saveServiceSettings(serviceType) {
            try {
                const formData = new FormData(document.getElementById('serviceSettingsForm'));

                const settings = {
                    operatingHours: {
                        startTime: formData.get('startTime'),
                        endTime: formData.get('endTime')
                    },
                    defaultBaseRate: parseInt(formData.get('defaultBaseRate')) || 0,
                    defaultAdditionalRate: parseInt(formData.get('defaultAdditionalRate')) || 0,
                    isActive: true
                };

                const response = await makeAdminRequest(`/ services / ${serviceType}/settings`, {
                    method: 'PUT',
                    body: JSON.stringify({ settings })
                });

                if (response?.ok) {
                    alert('Service settings updated successfully!');
                    closeModal();
                    loadServices(); // Refresh the services list
                } else {
                    const error = await response?.json();
                    alert(error?.error || 'Failed to update settings');
                }
            } catch (error) {
                console.error('Settings update error:', error);
                alert('Failed to update settings');
            }
        }

        async function editPricingItem(serviceType, index) {
            try {
                // Get the current service data
                const response = await makeAdminRequest(`/services/${serviceType}`);
                const service = await response.json();
                const pricingItem = service.pricing[index];

                if (!pricingItem) {
                    alert('Pricing item not found');
                    return;
                }

                // Create edit modal
                const modalContainer = document.getElementById('modalContainer');
                modalContainer.innerHTML = `
                    <div class="modal active">
                        <div class="modal-content" style="max-width: 700px;">
                            <div class="modal-header">
                                <h2 class="modal-title">Edit Pricing Item - ${getServiceDisplayName(serviceType)}</h2>
                                <button class="close-modal" onclick="closeModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="editPricingForm">
                                    <div class="form-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                        <div class="form-group">
                                            <label for="editDisplayName">Display Name</label>
                                            <input type="text" id="editDisplayName" name="displayName" value="${pricingItem.displayName}" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="editBaseRate">Base Rate (â‚¹)</label>
                                            <input type="number" id="editBaseRate" name="baseRate" value="${pricingItem.baseRate}" min="0" step="1" required>
                                            <small>Price for first hour</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="editAdditionalRate">Additional Rate (â‚¹)</label>
                                            <input type="number" id="editAdditionalRate" name="additionalRate" value="${pricingItem.additionalRate || 0}" min="0" step="1">
                                            <small>Rate per extra hour</small>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 1rem;">
                                        <div class="form-group">
                                            <label for="editMinHours">Min Hours</label>
                                            <input type="number" id="editMinHours" name="minHours" value="${pricingItem.minHours || 1}" min="0.5" step="0.5">
                                        </div>
                                        <div class="form-group">
                                            <label for="editApartmentSelection">Target Apartments</label>
                                            <div style="margin-bottom: 0.5rem;">
                                                <button type="button" id="editLoadApartments" style="background: #007bff; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 3px; font-size: 0.85rem; margin-right: 0.5rem;">Load Apartments</button>
                                                <button type="button" id="editSelectAllApartments" style="background: #28a745; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 3px; font-size: 0.85rem; margin-right: 0.5rem;">Select All</button>
                                                <button type="button" id="editClearApartments" style="background: #dc3545; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 3px; font-size: 0.85rem;">Clear All</button>
                                            </div>
                                            <select id="editApartmentSelection" name="apartmentSelection" multiple style="height: 100px; width: 100%;">
                                                <!-- Apartment options will be loaded dynamically -->
                                            </select>
                                            <small>Hold Ctrl/Cmd to select multiple. Empty selection = All apartments</small>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group" style="margin-bottom: 1rem;">
                                        <label for="editDescription">Description</label>
                                        <input type="text" id="editDescription" name="description" value="${pricingItem.description || ''}" placeholder="Brief description of the service">
                                    </div>
                                    
                                    <div style="text-align: right; margin-top: 2rem;">
                                        <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                                        <button type="submit" class="btn-primary">Update Pricing Item</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;

                // Load apartments and set up form
                await loadApartmentsForEdit(serviceType, pricingItem);

                // Set up form submission
                document.getElementById('editPricingForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    updatePricingItem(serviceType, index);
                });

            } catch (error) {
                console.error('Edit pricing item error:', error);
                alert('Failed to load pricing item for editing');
            }
        }

        // Load apartments for editing with current selections
        async function loadApartmentsForEdit(serviceType, pricingItem) {
            try {
                const response = await makeAdminRequest('/apartments');
                const data = await response.json();
                const apartmentSelect = document.getElementById('editApartmentSelection');

                if (apartmentSelect && data.apartments) {
                    // Clear and load all apartments
                    apartmentSelect.innerHTML = '';

                    data.apartments.forEach(apartment => {
                        const option = document.createElement('option');
                        option.value = apartment._id;
                        option.textContent = `${apartment.name} (${apartment.area})`;
                        // Pre-select apartments that were previously selected
                        option.selected = pricingItem.apartmentIds?.includes(apartment._id) || false;
                        apartmentSelect.appendChild(option);
                    });

                    // Add button functionality
                    document.getElementById('editLoadApartments')?.addEventListener('click', () => {
                        loadApartmentsForEdit(serviceType, pricingItem);
                    });

                    document.getElementById('editSelectAllApartments')?.addEventListener('click', () => {
                        Array.from(apartmentSelect.options).forEach(option => option.selected = true);
                    });

                    document.getElementById('editClearApartments')?.addEventListener('click', () => {
                        Array.from(apartmentSelect.options).forEach(option => option.selected = false);
                    });
                }
            } catch (error) {
                console.error('Failed to load apartments for edit:', error);
            }
        }

        // Update pricing item
        async function updatePricingItem(serviceType, index) {
            try {
                const formData = new FormData(document.getElementById('editPricingForm'));

                // Get selected apartments
                const apartmentSelect = document.getElementById('editApartmentSelection');
                const selectedOptions = Array.from(apartmentSelect.selectedOptions);
                const isAllApartments = selectedOptions.length === 0;

                const updatedPricingItem = {
                    serviceVariant: generateServiceVariant(formData.get('displayName')),
                    displayName: formData.get('displayName'),
                    baseRate: parseInt(formData.get('baseRate')) || 0,
                    additionalRate: parseInt(formData.get('additionalRate')) || 0,
                    minHours: parseFloat(formData.get('minHours')) || 1,
                    apartmentIds: isAllApartments ? [] : selectedOptions.map(opt => opt.value),
                    apartmentNames: isAllApartments ? [] : selectedOptions.map(opt => opt.text),
                    description: formData.get('description') || '',
                    operatingHours: {
                        startTime: '06:00',
                        endTime: '19:00'
                    },
                    isActive: true
                };

                const response = await makeAdminRequest(`/services/${serviceType}/pricing/${index}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatedPricingItem)
                });

                if (response?.ok) {
                    closeModal();
                    loadServiceForPricingEdit(serviceType);
                    alert('Pricing item updated successfully!');
                } else {
                    const error = await response?.json();
                    alert(error?.error || 'Failed to update pricing item');
                }
            } catch (error) {
                console.error('Update pricing item error:', error);
                alert('Failed to update pricing item');
            }
        }

        async function deletePricingItem(serviceType, index) {
            if (!confirm('Are you sure you want to delete this pricing item?')) {
                return;
            }

            try {
                const response = await makeAdminRequest(`/services/${serviceType}/pricing/${index}`, {
                    method: 'DELETE'
                });

                if (response?.ok) {
                    // Refresh the pricing editor
                    loadServiceForPricingEdit(serviceType);
                } else {
                    const error = await response?.json();
                    alert(error?.error || 'Failed to delete pricing item');
                }
            } catch (error) {
                console.error('Delete pricing item error:', error);
                alert('Failed to delete pricing item');
            }
        }

        function updateOrderStatus(orderId) {
            const modalContainer = document.getElementById('modalContainer');

            modalContainer.innerHTML = `
                <div class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Update Order Status</h2>
                            <button class="close-modal" onclick="closeModal()">&times;</button>
                        </div>
                        <form id="orderStatusForm">
                            <div class="form-group">
                                <label for="orderStatus">Order Status</label>
                                <select id="orderStatus" name="status" required>
                                    <option value="pending">Pending</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="statusNotes">Status Notes</label>
                                <textarea id="statusNotes" name="notes" rows="3" placeholder="Add any notes about this status change..."></textarea>
                            </div>
                            <div style="text-align: right; margin-top: 2rem;">
                                <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn-primary">Update Status</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('orderStatusForm').addEventListener('submit', (e) => {
                e.preventDefault();
                submitOrderStatusUpdate(orderId);
            });
        }

        async function submitOrderStatusUpdate(orderId) {
            try {
                const formData = new FormData(document.getElementById('orderStatusForm'));

                const statusData = {
                    status: formData.get('status'),
                    notes: formData.get('notes')
                };

                const response = await makeAPIRequest(`/orders/admin/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify(statusData)
                });

                if (response?.ok) {
                    alert('Order status updated successfully!');
                    closeModal();
                    loadOrders(); // Refresh the orders list
                } else {
                    const error = await response?.json();
                    alert(error?.error || 'Failed to update order status');
                }
            } catch (error) {
                console.error('Order status update error:', error);
                alert('Failed to update order status');
            }
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        async function loadServicesForWorkerForm() {
            try {
                const response = await makeAdminRequest('/services');
                if (!response?.ok) return;

                const services = await response.json();
                const container = document.getElementById('servicesCheckboxes');

                container.innerHTML = services.map(service => `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem;">
                        <input type="checkbox" value="${service._id}" data-service-id="${service._id}">
                        <span>${service.name}</span>
                    </label>
                `).join('');
            } catch (error) {
                console.error('Failed to load services:', error);
            }
        }

        async function loadAreasForWorkerForm() {
            try {
                const response = await fetch('/api/apartments/available');
                if (!response?.ok) return;

                const apartments = await response.json();
                const container = document.getElementById('areasCheckboxes');

                if (apartments.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No apartments available. Please add apartments first.</p>';
                    return;
                }

                container.innerHTML = apartments.map(apartment => `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem; border-bottom: 1px solid var(--border-light);">
                        <input type="checkbox" value="${apartment._id}" data-apartment-id="${apartment._id}" data-apartment-name="${apartment.name}">
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${apartment.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${apartment.area}, ${apartment.pincode}</div>
                        </div>
                    </label>
                `).join('');
            } catch (error) {
                console.error('Failed to load apartments:', error);
                const container = document.getElementById('areasCheckboxes');
                container.innerHTML = '<p style="color: var(--accent-red-text);">Failed to load apartments</p>';
            }
        }

        async function loadWorkerForEdit(workerId) {
            try {
                const response = await makeAdminRequest(`/workers/${workerId}`);
                if (!response?.ok) return;

                const worker = await response.json();

                // Fill form fields
                document.getElementById('workerName').value = worker.name || '';
                document.getElementById('workerPhone').value = worker.phone || '';
                document.getElementById('workerEmail').value = worker.email || '';
                document.getElementById('workerAadhar').value = worker.aadharNumber || '';
                document.getElementById('workerExperience').value = worker.experience || '';
                document.getElementById('workerStatus').value = worker.isActive ? 'true' : 'false';
                document.getElementById('workerNotes').value = worker.notes || '';

                // Check apartment checkboxes
                if (worker.areas && worker.areas.length > 0) {
                    worker.areas.forEach(apartment => {
                        const apartmentId = apartment._id || apartment;
                        const checkbox = document.querySelector(`input[data-apartment-id="${apartmentId}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                // Check service checkboxes
                const serviceIds = worker.services.map(s => s._id || s);
                serviceIds.forEach(serviceId => {
                    const checkbox = document.querySelector(`input[data-service-id="${serviceId}"]`);
                    if (checkbox) checkbox.checked = true;
                });

                // Populate specializations
                const container = document.getElementById('specializationsContainer');
                container.innerHTML = '';
                if (worker.specializations && worker.specializations.length > 0) {
                    worker.specializations.forEach(spec => {
                        addSpecializationRow(spec);
                    });
                }
            } catch (error) {
                console.error('Failed to load worker:', error);
            }
        }

        async function loadApartmentForEdit(apartmentId) {
            try {
                const response = await makeAdminRequest(`/apartments/${apartmentId}`);
                if (!response?.ok) return;

                const apartment = await response.json();

                // Fill form fields
                document.getElementById('apartmentName').value = apartment.name || '';
                document.getElementById('apartmentArea').value = apartment.area || '';
                document.getElementById('apartmentPincode').value = apartment.pincode || '';
                document.getElementById('apartmentUnits').value = apartment.totalUnits || '';
                document.getElementById('apartmentLandmark').value = apartment.landmark || '';
                document.getElementById('apartmentAmenities').value = apartment.amenities ? apartment.amenities.join(', ') : '';
                document.getElementById('apartmentStatus').value = apartment.isActive ? 'true' : 'false';
                document.getElementById('apartmentNotes').value = apartment.notes || '';

                // Management contact
                if (apartment.managementContact) {
                    document.getElementById('managementName').value = apartment.managementContact.name || '';
                    document.getElementById('managementPhone').value = apartment.managementContact.phone || '';
                    document.getElementById('managementEmail').value = apartment.managementContact.email || '';
                }
            } catch (error) {
                console.error('Failed to load apartment:', error);
            }
        }

        async function submitWorkerForm(isEdit, workerId) {
            try {
                const formData = new FormData(document.getElementById('workerForm'));

                // Get selected services
                const selectedServices = Array.from(document.querySelectorAll('#servicesCheckboxes input:checked'))
                    .map(cb => cb.value);

                const specializations = getSpecializationData();

                if (selectedServices.length === 0 && specializations.length === 0) {
                    alert('Please select at least one service or specialization');
                    return;
                }

                // Get selected apartments
                const selectedApartments = Array.from(document.querySelectorAll('#areasCheckboxes input:checked'))
                    .map(cb => cb.value);

                if (selectedApartments.length === 0) {
                    alert('Please select at least one apartment building');
                    return;
                }

                // Build worker object
                const workerData = {
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    aadharNumber: formData.get('aadharNumber'),
                    areas: selectedApartments,
                    services: selectedServices,
                    specializations: getSpecializationData(), // Collect specializations
                    experience: parseInt(formData.get('experience')) || 0,
                    isActive: formData.get('isActive') === 'true',
                    notes: formData.get('notes')
                };

                const url = isEdit ? `/workers/${workerId}` : '/workers';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await makeAdminRequest(url, {
                    method,
                    body: JSON.stringify(workerData)
                });

                if (response?.ok) {
                    alert(isEdit ? 'Worker updated successfully!' : 'Worker created successfully!');
                    closeModal();
                    loadWorkers(); // Refresh the workers list
                } else {
                    const error = await response?.json();
                    alert(error?.error || 'Failed to save worker');
                }
            } catch (error) {
                console.error('Worker submission error:', error);
                alert('Failed to save worker');
            }
        }

        async function submitApartmentForm(isEdit, apartmentId) {
            try {
                const formData = new FormData(document.getElementById('apartmentForm'));

                // Build apartment object
                const apartmentData = {
                    name: formData.get('name'),
                    area: formData.get('area'),
                    pincode: formData.get('pincode'),
                    landmark: formData.get('landmark'),
                    totalUnits: parseInt(formData.get('totalUnits')) || 0,
                    amenities: formData.get('amenities') ? formData.get('amenities').split(',').map(amenity => amenity.trim()).filter(amenity => amenity) : [],
                    isActive: formData.get('isActive') === 'true',
                    notes: formData.get('notes'),
                    managementContact: {
                        name: formData.get('managementName'),
                        phone: formData.get('managementPhone'),
                        email: formData.get('managementEmail')
                    }
                };

                const url = isEdit ? `/apartments/${apartmentId}` : '/apartments';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await makeAdminRequest(url, {
                    method,
                    body: JSON.stringify(apartmentData)
                });

                if (response?.ok) {
                    alert(isEdit ? 'Apartment updated successfully!' : 'Apartment created successfully!');
                    closeModal();
                    loadApartments(); // Refresh the apartments list
                } else {
                    const error = await response?.json();
                    alert(error?.error || 'Failed to save apartment');
                }
            } catch (error) {
                console.error('Apartment submission error:', error);
                alert('Failed to save apartment');
            }
        }

        function openUserModal(userId) {
            const modalContainer = document.getElementById('modalContainer');

            modalContainer.innerHTML = `
                <div class="modal active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Edit User</h2>
                            <button class="close-modal" onclick="closeModal()">&times;</button>
                        </div>
                        <div id="userEditContent">Loading user data...</div>
                    </div>
                </div>
            `;

            loadUserForEdit(userId);
        }

        async function loadUserForEdit(userId) {
            try {
                const response = await makeAdminRequest(`/users/${userId}`);
                if (!response?.ok) return;

                const { user } = await response.json();

                document.getElementById('userEditContent').innerHTML = `
                    <form id="userEditForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="userFullName">Full Name</label>
                                <input type="text" id="userFullName" name="fullName" value="${user.fullName || ''}">
                            </div>
                            <div class="form-group">
                                <label for="userPhone">Phone</label>
                                <input type="tel" id="userPhone" name="phone" value="${user.phone || ''}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="userEmail">Email</label>
                            <input type="email" id="userEmail" name="email" value="${user.email || ''}" readonly>
                            <small>Email cannot be changed</small>
                        </div>
                        <div class="form-group">
                            <label>Profile Information</label>
                            <div class="form-row">
                                <div class="form-group">
                                    <input type="text" name="apartmentName" placeholder="Apartment Name" value="${user.profile?.apartmentName || ''}">
                                </div>
                                <div class="form-group">
                                    <input type="text" name="flatNumber" placeholder="Flat Number" value="${user.profile?.flatNumber || ''}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <input type="text" name="area" placeholder="Area" value="${user.profile?.area || ''}">
                                </div>
                                <div class="form-group">
                                    <input type="text" name="pincode" placeholder="Pincode" value="${user.profile?.pincode || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="userVerified">Verification Status</label>
                            <select id="userVerified" name="isVerified">
                                <option value="true" ${user.isVerified ? 'selected' : ''}>Verified</option>
                                <option value="false" ${!user.isVerified ? 'selected' : ''}>Unverified</option>
                            </select>
                        </div>
                        <div style="text-align: right; margin-top: 2rem;">
                            <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="submit" class="btn-primary">Update User</button>
                        </div>
                    </form>
                `;

                document.getElementById('userEditForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    submitUserEditForm(userId);
                });
            } catch (error) {
                console.error('Failed to load user:', error);
                document.getElementById('userEditContent').innerHTML = '<p>Failed to load user data</p>';
            }
        }

        async function submitUserEditForm(userId) {
            try {
                const formData = new FormData(document.getElementById('userEditForm'));

                const userData = {
                    fullName: formData.get('fullName'),
                    phone: formData.get('phone'),
                    isVerified: formData.get('isVerified') === 'true',
                    profile: {
                        apartmentName: formData.get('apartmentName'),
                        flatNumber: formData.get('flatNumber'),
                        area: formData.get('area'),
                        pincode: formData.get('pincode')
                    }
                };

                const response = await makeAdminRequest(`/users/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify(userData)
                });

                if (response?.ok) {
                    alert('User updated successfully!');
                    closeModal();
                    loadUsers(); // Refresh the users list
                } else {
                    const error = await response?.json();
                    alert(error?.error || 'Failed to update user');
                }
            } catch (error) {
                console.error('User update error:', error);
                alert('Failed to update user');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userData');
                window.location.href = '/';
            }
        }

        // Setup search functionality
        document.getElementById('userSearch')?.addEventListener('input', (e) => {
            loadUsers(1, e.target.value);
        });

        document.getElementById('workerSearch')?.addEventListener('input', (e) => {
            loadWorkers(1, e.target.value);
        });

        document.getElementById('apartmentSearch')?.addEventListener('input', (e) => {
            loadApartments(1, e.target.value);
        });

        // Mobile sidebar toggle function
        function toggleSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            sidebar.classList.toggle('open');
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('adminSidebar');
            const toggle = document.querySelector('.mobile-menu-toggle');

            if (window.innerWidth <= 768 &&
                !sidebar.contains(e.target) &&
                !toggle.contains(e.target) &&
                sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }
        });

        // === SPECIFIC SERVICE MANAGEMENT LOGIC ===

        let currentServiceTab = 'car-wash';

        function switchServiceTab(serviceType) {
            currentServiceTab = serviceType;

            // Update Tab UI
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.style.color = 'var(--text-secondary)';
                btn.style.borderBottom = 'none';
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(`tab-${serviceType}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.color = 'var(--primary-color)';
                activeBtn.style.borderBottom = '2px solid var(--primary-color)';
            }

            // Show Panel
            document.querySelectorAll('.service-panel').forEach(panel => panel.style.display = 'none');
            const activePanel = document.getElementById(`panel-${serviceType}`);
            if (activePanel) activePanel.style.display = 'block';

            // Load Data
            loadPricing(serviceType);
        }

        // Global state for pricing data to support editing
        let currentPricingData = [];
        let editingRuleId = null;

        async function loadPricing(serviceType) {
            // camelCase conversion for ID (car-wash -> carWashPricingList)
            const listId = `${serviceType.replace(/-([a-z])/g, (g) => g[1].toUpperCase())}PricingList`;
            const container = document.getElementById(listId);
            if (!container) return;

            container.innerHTML = 'Loading...';

            try {
                const response = await makeAdminRequest(`/services/${serviceType}/pricing`);
                const pricingRules = await response.json();
                currentPricingData = pricingRules; // Store for editing

                if (pricingRules.length === 0) {
                    container.innerHTML = '<p style="color: #666; font-style: italic;">No pricing rules defined yet.</p>';
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                ${getPricingHeaders(serviceType)}
                                <th>Price</th>
                                <th>Apartment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pricingRules.map(rule => `
                                <tr>
                                    ${getPricingColumns(serviceType, rule)}
                                    <td>â‚¹${rule.price !== undefined ? rule.price : (rule.baseRate !== undefined ? rule.baseRate : (rule.basePrice || 0))}</td>
                                    <td>${rule.apartmentId || 'All Apartments'}</td>
                                    <td>
                                        <button class="btn-icon" onclick="openEditPricingRule('${serviceType}', '${rule._id}')" style="color: var(--primary-blue); margin-right: 0.5rem;">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                        <button class="btn-icon" onclick="deletePricingRule('${serviceType}', '${rule._id}')" style="color: #dc3545;">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Load pricing error:', error);
                container.innerHTML = '<p style="color: red;">Failed to load pricing.</p>';
            }
        }

        function getPricingHeaders(serviceType) {
            // Unified header for all service types
            return '<th>Service Details</th>';
        }

        function getPricingColumns(serviceType, rule) {
            // Use displayName if available, otherwise fallback to legacy fields construction
            let display = rule.displayName;

            if (!display) {
                switch (serviceType) {
                    case 'car-wash':
                        display = `${rule.carType || ''} - ${rule.packageType || ''} (${rule.serviceType || ''})`;
                        break;
                    case 'cook':
                        display = `${rule.mealType || ''} for ${rule.peopleCount || ''} people (${rule.duration || '-'} hrs)`;
                        break;
                    case 'driver':
                        display = `${rule.serviceType || ''} - ${rule.vehicleType || ''}`;
                        break;
                    case 'maid':
                        display = `${rule.maidType || ''} - ${rule.bhkType || ''} (${rule.duration || '-'} hrs)`;
                        break;
                    case 'pest-control':
                        display = `${rule.treatmentType || ''} - ${rule.bhkType || ''} (Level ${rule.serviceLevel || ''})`;
                        break;
                    case 'deep-cleaning':
                        display = `${rule.serviceName || ''} - ${rule.category || ''}`;
                        break;
                    default:
                        display = rule.serviceVariant || 'Unknown Variant';
                }
            }

            // Clean up any double separators or trailing/leading punctuation from empty fields
            display = display.replace(/^ - | - $/, '').trim();

            return `<td><strong>${display}</strong><br><small style="color:#666">${rule.description || ''}</small></td>`;
        }

        async function deletePricingRule(serviceType, id) {
            if (!confirm('Delete this pricing rule?')) return;
            try {
                const response = await makeAdminRequest(`/services/${serviceType}/pricing/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadPricing(serviceType);
                } else {
                    alert('Failed to delete rule');
                }
            } catch (e) {
                console.error(e);
                alert('Failed to delete rule');
            }
        }

        function openEditPricingRule(serviceType, ruleId) {
            const rule = currentPricingData.find(r => r._id === ruleId);
            if (!rule) return;

            // Open the normal modal first to generate HTML with hidden field
            openAddPricingModal(serviceType);

            // Populate hidden ID
            const form = document.getElementById('addPricingForm');
            if (form && form.elements['pricingId']) {
                form.elements['pricingId'].value = ruleId;
            }

            // Update Title and Button
            document.querySelector('#pricingModal .modal-title').textContent = 'Edit Pricing Rule';
            document.querySelector('#pricingModal button[type="submit"]').textContent = 'Update Rule';

            // Populate Form Fields
            // form variable is already defined above

            // Display & Basic Fields
            if (form.displayName) form.displayName.value = rule.displayName || '';
            if (form.baseRate) form.baseRate.value = rule.baseRate || rule.price || 0; // Fallback to price
            if (form.additionalRate) form.additionalRate.value = rule.additionalRate || 0;
            if (form.minHours) form.minHours.value = rule.minHours || 1;
            if (form.description) form.description.value = rule.description || '';
            if (form.price) form.price.value = rule.price || 0; // Legacy field

            // Apartment - wait for loading or set timeout
            setTimeout(() => {
                if (form.apartmentId) form.apartmentId.value = rule.apartmentId || '';
            }, 500);

            // Specific Fields (Mapping depends on service type)
            // Car Wash
            if (form.vehicleType && (rule.vehicleType || rule.carType)) form.vehicleType.value = rule.vehicleType || rule.carType;
            if (form.serviceType && rule.serviceType) form.serviceType.value = rule.serviceType;
            if (form.packageType && rule.packageType) form.packageType.value = rule.packageType; // Note: Form might use 'serviceType' for this in some cases

            // Maid / Cook / Driver / Pest / Deep Cleaning specific fields
            if (form.maidType && rule.maidType) form.maidType.value = rule.maidType;
            if (form.bhkType && rule.bhkType) form.bhkType.value = rule.bhkType;
            if (form.treatmentType && rule.treatmentType) form.treatmentType.value = rule.treatmentType;
            if (form.serviceLevel && rule.serviceLevel) form.serviceLevel.value = rule.serviceLevel;
            if (form.category && rule.category) form.category.value = rule.category;
            if (form.serviceName && rule.serviceName) form.serviceName.value = rule.serviceName;

            // Generic Duration
            if (form.duration) {
                // Handle cases where duration might be a number or string
                if (typeof rule.duration === 'number') {
                    form.duration.value = rule.duration;
                } else if (typeof rule.duration === 'string' && !isNaN(parseFloat(rule.duration))) {
                    form.duration.value = parseFloat(rule.duration);
                } else {
                    form.duration.value = rule.duration || ''; // Keep string if not a number
                }
            }
            if (form.peopleCount && rule.peopleCount) form.peopleCount.value = rule.peopleCount;
        }

        async function addPricingRule(serviceType, formData) {
            const data = Object.fromEntries(formData.entries());
            // Convert numbers
            if (data.price) data.price = Number(data.price);
            if (data.baseRate) data.baseRate = Number(data.baseRate);
            if (data.additionalRate) data.additionalRate = Number(data.additionalRate);
            if (data.minHours) data.minHours = Number(data.minHours);

            // Legacy/Fallback: Ensure price is set if baseRate exists
            if (!data.price && data.baseRate) data.price = data.baseRate;

            if (data.duration) data.duration = Number(data.duration);
            if (data.peopleCount) data.peopleCount = Number(data.peopleCount);
            if (data.apartmentId === "") data.apartmentId = null; // Backend expects null or valid ID

            try {
                let response;
                if (editingRuleId) {
                    // Update existing
                    response = await makeAdminRequest(`/services/${serviceType}/pricing/${editingRuleId}`, {
                        method: 'PUT', // Use PUT for updates
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new
                    response = await makeAdminRequest(`/services/${serviceType}/pricing/add`, {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    alert(editingRuleId ? 'Pricing rule updated!' : 'Pricing rule added!');
                    closeModal();
                    loadPricing(serviceType);
                    editingRuleId = null; // Reset
                } else {
                    const err = await response.json();
                    alert(err.error || 'Failed to save pricing');
                }
            } catch (e) {
                console.error(e);
                alert('Failed to save pricing rule');
            }
        }

        // Reset editing state when opening modal fresh
        const originalOpenAddPricingModal = openAddPricingModal;
        // Initialize with default tab
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('tab-car-wash')) {
                switchServiceTab('car-wash');
            }
        });


        function openAddPricingModal(serviceType) {
            const modalContainer = document.getElementById('modalContainer');
            let formFields = '';
            let title = '';

            switch (serviceType) {
                case 'car-wash':
                    title = 'Add Car Wash Pricing';
                    formFields = `
                        <div class="form-group">
                            <label>Service Type</label>
                            <select name="serviceType" required>
                                <option value="interior">Interior Cleaning</option>
                                <option value="exterior">Exterior Cleaning</option>
                                <option value="complete">Complete Wash</option>
                                <option value="detailing">Full Detailing</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Car Type</label>
                            <select name="carType" required>
                                <option value="hatchback">Hatchback</option>
                                <option value="sedan">Sedan</option>
                                <option value="suv">SUV</option>
                                <option value="luxury">Luxury</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Package Type</label>
                            <select name="packageType" required>
                                <option value="basic">Basic Package</option>
                                <option value="premium">Premium Package</option>
                                <option value="deluxe">Deluxe Package</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'cook':
                    title = 'Add Cook Pricing';
                    formFields = `
                        <div class="form-group">
                            <label>Meal Type</label>
                            <select name="mealType" required>
                                <option value="breakfast">Breakfast</option>
                                <option value="lunch">Lunch</option>
                                <option value="dinner">Dinner</option>
                                <option value="breakfast_lunch">Breakfast + Lunch</option>
                                <option value="lunch_dinner">Lunch + Dinner</option>
                                <option value="all_meals">All Meals</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>People Count</label>
                            <input type="number" name="peopleCount" min="1" max="20" required value="4">
                        </div>
                        <div class="form-group">
                            <label>Service Type</label>
                            <select name="serviceType" required>
                                <option value="hourly">Hourly</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duration (Hours)</label>
                            <input type="number" name="duration" min="0.5" step="0.5" required value="1">
                        </div>
                    `;
                    break;
                case 'driver':
                    title = 'Add Driver Pricing';
                    formFields = `
                        <div class="form-group">
                            <label>Service Type</label>
                            <select name="serviceType" required>
                                <option value="hourly">Hourly</option>
                                <option value="trip_based">Trip Based (One Way/Round)</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Vehicle Type</label>
                            <select name="vehicleType" required>
                                <option value="any">Any Vehicle</option>
                                <option value="hatchback">Hatchback</option>
                                <option value="sedan">Sedan</option>
                                <option value="suv">SUV</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duration (Hours/Days)</label>
                            <input type="number" name="duration" min="1" required value="4">
                        </div>
                    `;
                    break;
                case 'maid':
                    title = 'Add Maid Pricing';
                    formFields = `
                        <div class="form-group">
                            <label>Maid Type</label>
                            <select name="maidType" required>
                                <option value="normal_maid">Normal Maid</option>
                                <option value="super_maid">Super Maid</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>BHK Type</label>
                            <select name="bhkType" required>
                                <option value="1bhk">1 BHK</option>
                                <option value="2bhk">2 BHK</option>
                                <option value="3bhk">3 BHK</option>
                                <option value="4bhk">4 BHK</option>
                                <option value="5bhk_plus">5 BHK+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Service Type</label>
                            <select name="serviceType" required>
                                <option value="hourly">Hourly</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duration (Hours)</label>
                            <input type="number" name="duration" min="0.5" step="0.5" required value="1">
                        </div>
                    `;
                    break;
                case 'pest-control':
                    title = 'Add Pest Control Pricing';
                    formFields = `
                        <div class="form-group">
                            <label>Treatment Type</label>
                            <select name="treatmentType" required>
                                <option value="general_pest">General Pest Control</option>
                                <option value="cockroach">Cockroach Treatment</option>
                                <option value="termite">Termite Treatment</option>
                                <option value="rodent">Rodent Control</option>
                                <option value="comprehensive">Comprehensive Treatment</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>BHK Type</label>
                            <select name="bhkType" required>
                                <option value="1bhk">1 BHK</option>
                                <option value="2bhk">2 BHK</option>
                                <option value="3bhk">3 BHK</option>
                                <option value="4bhk">4 BHK</option>
                                <option value="5bhk_plus">5 BHK+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Service Level</label>
                            <select name="serviceLevel" required>
                                <option value="basic">Basic Treatment</option>
                                <option value="advanced">Advanced Treatment</option>
                                <option value="premium">Premium Treatment</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'deep-cleaning':
                    title = 'Add Deep Cleaning Pricing';
                    formFields = `
                        <div class="form-group">
                            <label>Category</label>
                            <select name="category" required>
                                <option value="bathroom">Bathroom Cleaning</option>
                                <option value="kitchen">Kitchen Cleaning</option>
                                <option value="full-home">Full Home Cleaning</option>
                                <option value="sofa-carpet">Sofa & Carpet Cleaning</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Service Name (Item)</label>
                            <input type="text" name="serviceName" placeholder="e.g. Classic Cleaning (2 Bathrooms)" required>
                        </div>
                        <div class="form-group">
                            <label>Details / Variant</label>
                            <input type="text" name="details" placeholder="e.g. 1BHK Furnished, 3 Seater Sofa">
                        </div>
                        <div class="form-group">
                            <label>Duration</label>
                            <input type="text" name="duration" placeholder="e.g. 2 hours" value="2 hours">
                        </div>
                    `;
                    break;
            }

            modalContainer.innerHTML = `
                <div class="modal active" id="pricingModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">${title}</h2>
                            <button class="close-modal" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="addPricingForm">
                                <input type="hidden" name="pricingId" value="">
                                ${formFields}
                                
                                <h4 style="margin: 1.5rem 0 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #eee; color: var(--primary-color);">Pricing & Display</h4>
                                
                                <div class="form-group">
                                    <label>Display Name <span style="color:red">*</span></label>
                                    <input type="text" name="displayName" required placeholder="e.g. Normal Maid - 2BHK" style="width: 100%; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px;">
                                    <small style="color: #666;">This title appears on the booking card</small>
                                </div>

                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>Base Rate (â‚¹) <span style="color:red">*</span></label>
                                        <input type="number" name="baseRate" required min="0" placeholder="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Addt'l Rate (â‚¹/hr)</label>
                                        <input type="number" name="additionalRate" value="0" min="0">
                                        <small style="color: #666;">Set > 0 for hourly calculation</small>
                                    </div>
                                </div>

                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>Min Hours</label>
                                        <input type="number" name="minHours" value="1" min="0.5" step="0.5">
                                    </div>
                                    <div class="form-group">
                                        <label>Apartment (Optional)</label>
                                        <select name="apartmentId" id="modalApartmentSelect">
                                            <option value="">All Apartments</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea name="description" rows="2" placeholder="e.g. Includes sweeping..."></textarea>
                                </div>
                                <div style="text-align: right; margin-top: 1.5rem;">
                                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                                    <button type="submit" class="btn-primary">Save Rule</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            // Populate apartments
            loadApartmentOptions();

            // Handle Submit
            document.getElementById('addPricingForm').addEventListener('submit', (e) => {
                e.preventDefault();
                addPricingRule(serviceType, new FormData(e.target));
            });
        }

        async function loadApartmentOptions() {
            try {
                const response = await makeAdminRequest('/apartments');
                const { apartments } = await response.json();
                const select = document.getElementById('modalApartmentSelect');
                if (select && apartments) {
                    apartments.forEach(apt => {
                        const opt = document.createElement('option');
                        opt.value = apt._id;
                        opt.textContent = apt.name;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error('Failed to load apartments for modal');
            }
        }

        async function addPricingRule(serviceType, formData) {
            const data = Object.fromEntries(formData.entries());
            const pricingId = data.pricingId; // Get ID from hidden field
            delete data.pricingId; // Remove ID from payload body

            // Convert numbers
            if (data.price) data.price = Number(data.price);
            if (data.baseRate) data.baseRate = Number(data.baseRate);
            if (data.additionalRate) data.additionalRate = Number(data.additionalRate);
            if (data.minHours) data.minHours = Number(data.minHours);

            // Legacy/Fallback: Ensure price is set if baseRate exists
            if (!data.price && data.baseRate) data.price = data.baseRate;

            if (data.duration) data.duration = Number(data.duration);
            if (data.peopleCount) data.peopleCount = Number(data.peopleCount);
            if (data.apartmentId === "") data.apartmentId = null; // Backend expects null or valid ID

            try {
                let response;
                if (pricingId) {
                    // Update existing using PUT
                    response = await makeAdminRequest(`/services/${serviceType}/pricing/${pricingId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new using POST
                    response = await makeAdminRequest(`/services/${serviceType}/pricing/add`, {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    alert(pricingId ? 'Pricing rule updated!' : 'Pricing rule added!');
                    closeModal();
                    loadPricing(serviceType);
                } else {
                    const err = await response.json();
                    alert(err.error || 'Failed to save pricing');
                }
            } catch (e) {
                console.error(e);
                alert('Failed to save pricing rule');
            }
        }

        // === WORKER SPECIALIZATIONS HELPERS ===

        const SERVICE_VARIANTS = {
            'maid': ['normal_maid', 'super_maid'],
            'cook': ['breakfast', 'lunch', 'dinner', 'breakfast_lunch', 'lunch_dinner', 'all_meals'],
            'driver': ['hatchback', 'sedan', 'suv', 'luxury'],
            'carwash': ['interior', 'exterior', 'complete', 'detailing'],
            'pestcontrol': ['general_pest', 'cockroach', 'termite', 'rodent'],
            'deepcleaning': ['bathroom', 'kitchen', 'full-home', 'sofa-carpet']
        };

        function addSpecializationRow(data = null) {
            const container = document.getElementById('specializationsContainer');
            const rowId = 'spec-row-' + Date.now() + Math.random().toString(36).substr(2, 5);

            const row = document.createElement('div');
            row.id = rowId;
            row.className = 'specialization-row';
            row.style = 'background: #f8f9fa; padding: 0.8rem; border-radius: 6px; margin-bottom: 0.8rem; border: 1px dashed #ddd; position: relative;';

            row.innerHTML = `
                <button type="button" onclick="document.getElementById('${rowId}').remove()" style="position: absolute; right: 5px; top: 5px; border: none; background: none; color: #dc3545; cursor: pointer;">
                    <i class="bi bi-x-circle-fill"></i>
                </button>
                <div class="form-group" style="margin-bottom: 0.5rem;">
                    <label style="font-size: 0.8rem;">Service Type</label>
                    <select class="spec-service-type" onchange="updateSubTypesList('${rowId}')" style="font-size: 0.85rem; padding: 0.3rem;">
                        <option value="">Select Service</option>
                        <option value="maid" ${data?.serviceType === 'maid' ? 'selected' : ''}>Maid</option>
                        <option value="cook" ${data?.serviceType === 'cook' ? 'selected' : ''}>Cook</option>
                        <option value="driver" ${data?.serviceType === 'driver' ? 'selected' : ''}>Driver</option>
                        <option value="carwash" ${data?.serviceType === 'carwash' ? 'selected' : ''}>Car Wash</option>
                        <option value="pestcontrol" ${data?.serviceType === 'pestcontrol' ? 'selected' : ''}>Pest Control</option>
                        <option value="deepcleaning" ${data?.serviceType === 'deepcleaning' ? 'selected' : ''}>Deep Cleaning</option>
                    </select>
                </div>
                <div class="spec-subtypes-container" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                    <!-- Sub-types will be populated here -->
                </div>
            `;

            container.appendChild(row);
            if (data) {
                updateSubTypesList(rowId, data.subTypes);
            }
        }

        function updateSubTypesList(rowId, selectedSubTypes = []) {
            const row = document.getElementById(rowId);
            if (!row) return;
            const serviceType = row.querySelector('.spec-service-type').value;
            const container = row.querySelector('.spec-subtypes-container');

            container.innerHTML = '';
            if (!serviceType || !SERVICE_VARIANTS[serviceType]) return;

            SERVICE_VARIANTS[serviceType].forEach(variant => {
                const isChecked = selectedSubTypes.includes(variant);
                container.innerHTML += `
                    <label style="font-size: 0.75rem; background: ${isChecked ? '#e9ecef' : 'white'}; padding: 0.2rem 0.5rem; border: 1px solid #ddd; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                        <input type="checkbox" class="spec-subtype-cb" value="${variant}" ${isChecked ? 'checked' : ''} onchange="this.parentElement.style.background = this.checked ? '#e9ecef' : 'white'">
                        ${variant.replace('_', ' ')}
                    </label>
                `;
            });
        }

        function getSpecializationData() {
            const rows = document.querySelectorAll('.specialization-row');
            const specializations = [];

            rows.forEach(row => {
                const serviceType = row.querySelector('.spec-service-type').value;
                const subTypes = Array.from(row.querySelectorAll('.spec-subtype-cb:checked')).map(cb => cb.value);

                if (serviceType && subTypes.length > 0) {
                    specializations.push({ serviceType, subTypes });
                }
            });

            return specializations;
        }

        // === Order Management Functions ===

        async function viewOrderDetails(orderId) {
            try {
                // Use the new admin-specific endpoint
                const response = await makeAPIRequest(`/orders/admin/details/${orderId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch order details');
                }
                const order = await response.json();

                // Format date
                const scheduleDate = new Date(order.scheduledDate).toLocaleDateString(undefined, {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });

                // Format duration
                let formattedDuration = `${order.duration} mins`;
                if (order.duration >= 60) {
                    const hours = Math.floor(order.duration / 60);
                    const mins = order.duration % 60;
                    formattedDuration = mins > 0 ? `${hours} hr ${mins} mins` : `${hours} hr${hours > 1 ? 's' : ''}`;
                }

                const modalContainer = document.getElementById('modalContainer');
                modalContainer.innerHTML = `
                    <div class="modal active">
                        <div class="modal-content" style="max-width: 700px;">
                            <div class="modal-header">
                                <h2 class="modal-title">Order #${order.orderNumber}</h2>
                                <button class="close-modal" onclick="closeModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; border-bottom: 1px solid #eee; padding-bottom: 1.5rem;">
                                    <div>
                                        <h4 style="color: #666; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.8rem;">Customer</h4>
                                        <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 0.2rem;">${order.user?.fullName || 'N/A'}</div>
                                        <div style="color: #555; margin-bottom: 0.2rem;"><i class="bi bi-envelope"></i> ${order.user?.email || 'N/A'}</div>
                                        <div style="color: #555;"><i class="bi bi-telephone"></i> ${order.user?.phone || 'N/A'}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <h4 style="color: #666; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.8rem;">Current Status</h4>
                                        <span class="status-badge status-${order.status}" style="font-size: 1rem; padding: 0.5rem 1rem;">${order.status.toUpperCase()}</span>
                                    </div>
                                </div>

                                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                    <h4 style="color: #333; margin-bottom: 1rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem; display: flex; justify-content: space-between;">
                                        <span>Service Information</span>
                                        <span style="color: var(--primary-color);">â‚¹${order.totalAmount}</span>
                                    </h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                        <div>
                                            <span style="color: #666; display: block; font-size: 0.85rem;">Service Type</span>
                                            <strong style="font-size: 1.05rem;">${order.service?.name || 'Unknown Service'}</strong>
                                        </div>
                                        <div>
                                            <span style="color: #666; display: block; font-size: 0.85rem;">Scheduled For</span>
                                            <strong>${scheduleDate}</strong><br>
                                            <span style="color: #666; font-size: 0.9rem;">Time: ${order.scheduledTime}</span>
                                        </div>
                                        <div>
                                            <span style="color: #666; display: block; font-size: 0.85rem;">Duration</span>
                                            <strong>${formattedDuration}</strong>
                                        </div>
                                         <div>
                                            <span style="color: #666; display: block; font-size: 0.85rem;">Booking Type</span>
                                            <strong>${order.bookingType} / ${order.planType}</strong>
                                        </div>
                                    </div>
                                </div>

                                <div style="margin-bottom: 1.5rem;">
                                    <h4 style="color: #333; margin-bottom: 0.8rem; font-size: 1rem;">Service Address</h4>
                                    <div style="background: white; border: 1px solid #eee; padding: 1rem; border-radius: 6px;">
                                        <strong style="color: #333;">${order.address?.apartmentName || ''}</strong><br>
                                        ${order.address?.flatNumber ? 'Flat/Unit: ' + order.address.flatNumber + '<br>' : ''}
                                        ${order.address?.area || ''}<br>
                                        ${order.address?.landmark ? 'Near ' + order.address.landmark + '<br>' : ''}
                                        Pincode: ${order.address?.pincode || 'N/A'}
                                    </div>
                                </div>

                                ${order.specialInstructions ? `
                                    <div style="margin-bottom: 1.5rem;">
                                        <h4 style="color: #333; margin-bottom: 0.8rem; font-size: 1rem;">Special Instructions</h4>
                                        <p style="background: #fff8e1; color: #856404; padding: 1rem; border-radius: 6px; border: 1px solid #ffeeba; margin: 0;">
                                            ${order.specialInstructions}
                                        </p>
                                    </div>
                                ` : ''}

                                <div style="text-align: right; margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem;">
                                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                                    <button class="btn-primary" onclick="updateOrderStatus('${order._id}')">Update Status</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching order details:', error);
                alert('Failed to load order details');
            }
        }

        function updateOrderStatus(orderId) {
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.innerHTML = `
                 <div class="modal active">
                     <div class="modal-content" style="max-width: 500px;">
                         <div class="modal-header">
                             <h2 class="modal-title">Update Order Status</h2>
                             <button class="close-modal" onclick="closeModal()">&times;</button>
                         </div>
                         <div class="modal-body">
                             <div style="background: #e3f2fd; color: #0d47a1; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; font-size: 0.9rem;">
                                <i class="bi bi-info-circle-fill" style="margin-right: 5px;"></i>
                                Updating the status will automatically send an email notification to the customer.
                             </div>
                             
                             <div class="form-group" style="margin-bottom: 1.5rem;">
                                 <label for="newStatus" style="font-weight: 600; margin-bottom: 0.5rem; display: block;">New Status</label>
                                 <select id="newStatus" class="form-control" style="width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;">
                                     <option value="pending">Pending</option>
                                     <option value="confirmed">Confirmed</option>
                                     <option value="in_progress">In Progress</option>
                                     <option value="completed">Completed</option>
                                     <option value="cancelled">Cancelled</option>
                                 </select>
                             </div>
                             
                             <div class="form-group" style="margin-bottom: 1.5rem;">
                                 <label for="statusNotes" style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Notes for Customer (Optional)</label>
                                 <textarea id="statusNotes" class="form-control" rows="3" placeholder="Add a message that will be included in the email..." style="width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 4px; font-family: inherit;"></textarea>
                             </div>
                             
                             <div style="text-align: right; display: flex; justify-content: flex-end; gap: 1rem;">
                                 <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                                 <button class="btn-primary" onclick="submitOrderStatus('${orderId}')">Update Status</button>
                             </div>
                         </div>
                     </div>
                 </div>
             `;
        }

        async function submitOrderStatus(orderId) {
            const status = document.getElementById('newStatus').value;
            const notes = document.getElementById('statusNotes').value;
            const btn = document.querySelector('button[onclick^="submitOrderStatus"]');

            // Disable button and show loading
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'Updating...';

            try {
                const response = await makeAPIRequest(`/orders/admin/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status, notes })
                });

                if (response.ok) {
                    alert(`Order status updated to ${status.toUpperCase()} successfully!`);
                    closeModal();
                    loadOrders(); // Refresh table
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to update status');
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            } catch (error) {
                console.error('Status update error:', error);
                alert('Failed to update status');
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
    </script>
</body>

</html>